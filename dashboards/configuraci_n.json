{
  "title": "Configuración",
  "configuration": {
    "widgets": {
      "fba8b82f-4b63-d360-68e1-9481f57706b1": {
        "isSystemType": true,
        "bundleAlias": "cards",
        "typeAlias": "entities_hierarchy",
        "type": "latest",
        "title": "New widget",
        "sizeX": 9,
        "sizeY": 11,
        "config": {
          "timewindow": {
            "realtime": {
              "interval": 1000,
              "timewindowMs": 86400000
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "4px",
          "settings": {
            "nodeRelationQueryFunction": "/**\n\n// Function should return relations query object for current node used to fetch entity children.\n// Function can return 'default' string value. In this case default relations query will be used.\n\n// The following example code will construct simple relations query that will fetch relations of type 'Contains'\n// from the current entity.\n\nvar entity = nodeCtx.entity;\nvar query = {\n    parameters: {\n        rootId: entity.id.id,\n        rootType: entity.id.entityType,\n        direction: types.entitySearchDirection.from,\n        relationTypeGroup: \"COMMON\",\n        maxLevel: 1\n    },\n    filters: [{\n        relationType: \"Contains\",\n        entityTypes: []\n    }]\n};\nreturn query;\n\n**/\n",
            "nodeHasChildrenFunction": "/**\n\n// Function should return boolean value indicating whether current node has children (whether it can be expanded).\n\n// The following example code will restrict entities hierarchy expansion up to third level.\n\nreturn nodeCtx.level <= 2;\n\n// The next example code will restrict entities expansion according to the value of example 'nodeHasChildren' attribute.\n\nvar data = nodeCtx.data;\nif (data.hasOwnProperty('nodeHasChildren') && data['nodeHasChildren'] !== null) {\n    return data['nodeHasChildren'] === 'true';\n} else {\n    return true;\n}\n  \n**/\n ",
            "nodeTextFunction": "/**\n\n// Function should return text (can be HTML code) for the current node.\n\n// The following example code will generate node text consisting of entity name and temperature if temperature value is present in entity attributes/timeseries.\n\nvar data =  nodeCtx.data;\nvar entity = nodeCtx.entity;\nvar text = entity.name;\nif (data.hasOwnProperty('temperature') && data['temperature'] !== null) {\n    text += \" <b>\"+ data['temperature'] +\" °C</b>\";\n}\nreturn text;\n\n**/\n\n//return \" <b>\"+nodeCtx.data['nombreEntidad']+\"</b>\";\nvar entity = nodeCtx.entity;\nvar nombreCompleto = entity.name;\nvar nombre = nombreCompleto.substring(nombreCompleto.indexOf(\"_\")+1);\n//console.log(nodeCtx.data);\nreturn nombre;",
            "nodeIconFunction": "/** \n\n// Function should return node icon info object.\n// Resulting object should contain either 'materialIcon' or 'iconUrl' property. \n// Where:\n    - 'materialIcon' - name of the material icon to be used from the Material Icons Library (https://material.io/tools/icons);\n    - 'iconUrl' - url of the external image to be used as node icon.\n// Function can return 'default' string value. In this case default icons according to entity type will be used.\n\n// The following example code shows how to use external image for devices which name starts with 'Test' and use \n// default icons for the rest of entities.\n\nvar entity = nodeCtx.entity;\nif (entity.id.entityType === 'DEVICE' && entity.name.startsWith('Test')) {\n    return {iconUrl: 'https://avatars1.githubusercontent.com/u/14793288?v=4&s=117'};\n} else {\n    return 'default';\n}\n \n**/",
            "nodeDisabledFunction": "/**\n\n// Function should return boolean value indicating whether current node should be disabled (not selectable).\n\n// The following example code will disable current node according to the value of example 'nodeDisabled' attribute.\n\nvar data = nodeCtx.data;\nif (data.hasOwnProperty('nodeDisabled') && data['nodeDisabled'] !== null) {\n    return data['nodeDisabled'] === 'true';\n} else {\n    return false;\n}\n  \n**/\n",
            "nodesSortFunction": "/**\n\n// This function is used to sort nodes of the same level. Function should compare two nodes and return \n// integer value: \n//     - less than 0 - sort nodeCtx1 to an index lower than nodeCtx2\n//     - 0 - leave nodeCtx1 and nodeCtx2 unchanged with respect to each other\n//     - greater than 0 - sort nodeCtx2 to an index lower than nodeCtx1\n\n// The following example code will sort entities first by entity type in alphabetical order then\n// by entity name in alphabetical order.\n\nvar result = nodeCtx1.entity.id.entityType.localeCompare(nodeCtx2.entity.id.entityType);\nif (result === 0) {\n    result = nodeCtx1.entity.name.localeCompare(nodeCtx2.entity.name);\n}\nreturn result;\n  \n**/",
            "nodeOpenedFunction": "/**\n\n// Function should return boolean value indicating whether current node should be opened (expanded) when it first loaded.\n\n// The following example code will open by default nodes up to third level.\n\nreturn nodeCtx.level <= 2;\n\n**/\n //return nodeCtx.level <=1;"
          },
          "title": "ACTIVOS Y DISPOSITIVOS",
          "dropShadow": true,
          "enableFullscreen": true,
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400,
            "padding": "5px 10px 5px 10px"
          },
          "useDashboardTimewindow": false,
          "showLegend": false,
          "datasources": [
            {
              "type": "entity",
              "dataKeys": [
                {
                  "name": "delegados",
                  "type": "attribute",
                  "label": "delegados",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.9463425840807203
                }
              ],
              "entityAliasId": "bc41b835-4a1d-49fc-de3b-142ec2484fd4"
            }
          ],
          "widgetStyle": {},
          "actions": {
            "nodeSelected": [
              {
                "id": "a7202234-d4a6-48e7-81ed-4cbc6e19ecab",
                "name": "click",
                "icon": "more_horiz",
                "type": "customPretty",
                "customHtml": "<md-dialog flex aria-label=\"Edit entity\">\r\n\r\n\r\n    <md-tabs md-dynamic-height md-border-bottom>\r\n        <md-tab label=\"Editar\">\r\n            <form name=\"form.editEntityFormNull\"\r\n                ng-if=\"vm.entity.type=='ROOT'\">\r\n                <md-toolbar>\r\n                    <div class=\"md-toolbar-tools\">\r\n                        <h2>Editar activo ROOT\r\n                        </h2>\r\n                        <span flex></span>\r\n                        <md-button class=\"md-icon-button\"\r\n                            ng-click=\"vm.cancel()\">\r\n                            <ng-md-icon icon=\"close\"\r\n                                aria-label=\"Close\">\r\n                            </ng-md-icon>\r\n                        </md-button>\r\n                    </div>\r\n                </md-toolbar>\r\n                <md-dialog-content>\r\n                    <div class=\"md-dialog-content\">El activo\r\n                        ROOT es un requisito del\r\n                        sistema\r\n                        que no se puede editar.</div>\r\n                </md-dialog-content>\r\n                <md-dialog-actions>\r\n                    <md-button ng-click=\"vm.cancel()\"\r\n                        class=\"md-primary\">Cancelar\r\n                    </md-button>\r\n                </md-dialog-actions>\r\n            </form>\r\n            <form name=\"form.editEntityForm\"\r\n                class=\"edit-entity-form\"\r\n                ng-submit=\"vm.save()\"\r\n                ng-if=\"vm.entity.type!='ROOT'\">\r\n                <md-toolbar>\r\n                    <div class=\"md-toolbar-tools\">\r\n                        <h2>Editar\r\n                            {{vm.entityType.toLowerCase()==\"asset\"?\"activo\":\"dispositivo\"}}\r\n                            {{vm.attributes.nombreEntidad}}\r\n                        </h2>\r\n                        <span flex></span>\r\n                        <md-button class=\"md-icon-button\"\r\n                            ng-click=\"vm.cancel()\">\r\n                            <ng-md-icon icon=\"close\"\r\n                                aria-label=\"Close\">\r\n                            </ng-md-icon>\r\n                        </md-button>\r\n                    </div>\r\n                </md-toolbar>\r\n                <md-dialog-content>\r\n                    <div class=\"md-dialog-content\">\r\n                        <div layout=\"row\">\r\n                            <md-input-container flex\r\n                                class=\"md-block\">\r\n                                <label>Nombre</label>\r\n                                <input type=\"text\"\r\n                                    ng-model=\"vm.attributes.nombreEntidad\"\r\n                                    required>\r\n                            </md-input-container>\r\n                            <md-input-container flex\r\n                                class=\"md-block\">\r\n                                <label\r\n                                    ng-if=\"vm.estaDelegado==false && vm.attributes.esDelegado==false\">Tipo</label>\r\n                                <label\r\n                                    ng-if=\"vm.estaDelegado==true || vm.attributes.esDelegado==true\">Tipo\r\n                                    (No se puede cambiar en\r\n                                    delegaciones)</label>\r\n                                <label\r\n                                    ng-if=\"vm.attributes.tipoEntidad.split('_').pop()=='FREE'\">Tipo\r\n                                    (No se puede cambiar en\r\n                                    dispositivos\r\n                                    FREE)</label>\r\n                                <md-select\r\n                                    ng-model=\"vm.attributes.tipoEntidad\"\r\n                                    required\r\n                                    ng-disabled=\"vm.estaDelegado==true || vm.attributes.esDelegado==true || vm.attributes.tipoEntidad.split('_').pop()=='FREE'\">\r\n\r\n                                    <md-option\r\n                                        ng-if=\"vm.entityType.toLowerCase()=='device'\"\r\n                                        ng-repeat=\"tipo in vm.tiposDeDispositivos\"\r\n                                        ng-value=\"tipo\"\r\n                                        ng-selected=\"{{tipo == vm.attributes.tipoEntidad}}\">\r\n                                        {{tipo}}\r\n                                    </md-option>\r\n                                    <md-option\r\n                                        ng-if=\"vm.entityType.toLowerCase()=='asset'\"\r\n                                        ng-repeat=\"tipo in vm.tiposDeActivos\"\r\n                                        ng-value=\"tipo\"\r\n                                        ng-selected=\"{{tipo == vm.attributes.tipoEntidad}}\">\r\n                                        {{tipo}}\r\n                                    </md-option>\r\n                                </md-select>\r\n                            </md-input-container>\r\n                            <md-input-container flex\r\n                                class=\"md-block\">\r\n                                <label>Padre</label>\r\n                                <md-select\r\n                                    ng-model=\"vm.padre\"\r\n                                    required>\r\n                                    <md-option\r\n                                        ng-repeat=\"(name,valor) in vm.activos\"\r\n                                        ng-value=\"name\"\r\n                                        ng-selected=\"{{name == vm.padre}}\">\r\n                                        {{valor.atributos.nombreEntidad}}/{{valor.atributos.tipoEntidad}}\r\n                                    </md-option>\r\n                                </md-select>\r\n                            </md-input-container>\r\n                        </div>\r\n                    </div>\r\n\r\n                </md-dialog-content>\r\n                <md-dialog-actions>\r\n                    <md-button type=\"submit\"\r\n                        ng-disabled=\"form.editEntityForm.$invalid || !form.editEntityForm.$dirty\"\r\n                        class=\"md-raised md-primary\">Aceptar\r\n                    </md-button>\r\n                    <md-button ng-click=\"vm.cancel()\"\r\n                        class=\"md-primary\">Cancelar\r\n                    </md-button>\r\n                </md-dialog-actions>\r\n            </form>\r\n        </md-tab>\r\n\r\n        <md-tab\r\n            ng-if=\"vm.entityType.toLowerCase()=='device' && vm.attributes.hasOwnProperty('esDelegado') && vm.attributes.esDelegado===false && vm.delegable\"\r\n            label=\"delegar\">\r\n            <md-toolbar>\r\n                <div class=\"md-toolbar-tools\">\r\n                    <h2>Delegar\r\n                        {{vm.attributes.nombreEntidad}}</h2>\r\n\r\n                    <span flex></span>\r\n                    <md-button class=\"md-icon-button\"\r\n                        ng-click=\"vm.cancel()\">\r\n                        <ng-md-icon icon=\"close\"\r\n                            aria-label=\"Close\">\r\n                        </ng-md-icon>\r\n                    </md-button>\r\n                </div>\r\n            </md-toolbar>\r\n            <!-- DELEGACIÓN DEL NODO -->\r\n            <sustituir-delegacion class=\"ng-scope\"></sustituir-delegacion>\r\n            <!-- DELEGACIÓN DEL NODO -->\r\n\r\n\r\n        </md-tab>\r\n\r\n        <md-tab label=\"crear\"\r\n            ng-if=\"vm.entityType.toLowerCase()=='asset'\">\r\n\r\n            <form name=\"form.addEntityForm\"\r\n                class=\"add-entity-form\"\r\n                ng-submit=\"vm.crear()\">\r\n                <md-toolbar>\r\n                    <div class=\"md-toolbar-tools\">\r\n                        <h2>Crear entidad hija de\r\n                            {{vm.attributes.nombreEntidad}}\r\n                        </h2>\r\n                        <span flex></span>\r\n                        <md-button class=\"md-icon-button\"\r\n                            ng-click=\"vm.cancel()\">\r\n                            <ng-md-icon icon=\"close\"\r\n                                aria-label=\"Close\">\r\n                            </ng-md-icon>\r\n                        </md-button>\r\n                    </div>\r\n                </md-toolbar>\r\n                <md-dialog-content>\r\n                    <div class=\"md-dialog-content\">\r\n                        <div layout=\"row\">\r\n                            <md-input-container flex\r\n                                class=\"md-block\"\r\n                                style=\"min-width: 100px; width: 150px;\">\r\n                                <label>Nombre</label>\r\n                                <input type=\"text\"\r\n                                    ng-model=\"vm.crearEntidad.nombreEntidad\"\r\n                                    name=nombreEntidad\r\n                                    required>\r\n                                <div\r\n                                    ng-messages=\"addEntityForm.nombreEntidad.$error\">\r\n                                    <div\r\n                                        ng-message=\"required\">\r\n                                        Es obligatorio\r\n                                        indicar un nombre.\r\n                                    </div>\r\n                                </div>\r\n                            </md-input-container>\r\n                            <tb-entity-type-select\r\n                                class=\"md-block\"\r\n                                style=\"min-width: 100px; width: 150px;\"\r\n                                the-form=\"addEntityForm\"\r\n                                tb-required=\"true\"\r\n                                allowed-entity-types=\"vm.allowedEntityTypes\"\r\n                                ng-model=\"vm.crearEntidad.tipoEntidad\">\r\n                            </tb-entity-type-select>\r\n\r\n                            <md-input-container flex\r\n                                class=\"md-block\"\r\n                                style=\"min-width: 100px; width: 150px;\">\r\n                                <label>Tipo de\r\n                                    {{vm.crearEntidad.tipoEntidad=='DEVICE'?'dispositivo':'activo'}}</label>\r\n                                <md-select\r\n                                    ng-model=\"vm.crearEntidad.subtipoEntidad\">\r\n                                    <md-option\r\n                                        ng-if=\"vm.crearEntidad.tipoEntidad.toLowerCase()=='device'\"\r\n                                        ng-repeat=\"tipo in vm.tiposDeDispositivos\"\r\n                                        ng-value=\"tipo\"\r\n                                        ng-selected=\"\">\r\n                                        {{tipo}}\r\n                                    </md-option>\r\n                                    <md-option\r\n                                        ng-if=\"vm.crearEntidad.tipoEntidad.toLowerCase()=='asset'\"\r\n                                        ng-repeat=\"tipo in vm.tiposDeActivos\"\r\n                                        ng-value=\"tipo\"\r\n                                        ng-selected=\"\">\r\n                                        {{tipo}}\r\n                                    </md-option>\r\n                                </md-select>\r\n                            </md-input-container>\r\n\r\n\r\n                        </div>\r\n                    </div>\r\n                </md-dialog-content>\r\n                <md-dialog-actions>\r\n                    <md-button type=\"submit\"\r\n                        ng-disabled=\"form.addEntityForm.$invalid || !form.addEntityForm.$dirty\"\r\n                        class=\"md-raised md-primary\">Crear\r\n                    </md-button>\r\n                    <md-button ng-click=\"vm.cancel()\"\r\n                        class=\"md-primary\">Cancelar\r\n                    </md-button>\r\n                </md-dialog-actions>\r\n            </form>\r\n        </md-tab>\r\n\r\n        <md-tab ng-if=\"vm.configurable\" label=\"configurar\">\r\n            <md-toolbar>\r\n                <div class=\"md-toolbar-tools\">\r\n                    <h2>Configurar\r\n                        {{vm.attributes.nombreEntidad}}\r\n                    </h2>\r\n                    <span flex></span>\r\n                    <md-button class=\"md-icon-button\"\r\n                        ng-click=\"vm.cancel()\">\r\n                        <ng-md-icon icon=\"close\"\r\n                            aria-label=\"Close\">\r\n                        </ng-md-icon>\r\n                    </md-button>\r\n                </div>\r\n            </md-toolbar>\r\n\r\n\r\n            <!-- CONFIGURACIÓN DEL NODO -->\r\n            <sustituir class=\"ng-scope\"></sustituir>\r\n            <!-- CONFIGURACIÓN DEL NODO -->\r\n\r\n\r\n        </md-tab>\r\n\r\n\r\n        <md-tab label=\"borrar\">\r\n            <form name=\"form.deleteEntityFormNull\"\r\n                ng-if=\"vm.entity.type=='ROOT' || vm.borrable==false\">\r\n                <md-toolbar>\r\n                    <div class=\"md-toolbar-tools\">\r\n                        <h2>Borrar\r\n                        </h2>\r\n                        <span flex></span>\r\n                        <md-button class=\"md-icon-button\"\r\n                            ng-click=\"vm.cancel()\">\r\n                            <ng-md-icon icon=\"close\"\r\n                                aria-label=\"Close\">\r\n                            </ng-md-icon>\r\n                        </md-button>\r\n                    </div>\r\n                </md-toolbar>\r\n                <md-dialog-content>\r\n                    <div class=\"md-dialog-content\">No se\r\n                        puede borrar el activo ROOT, ni los\r\n                        activos que tengan hijos, ni los\r\n                        dispositivos que estén delegados.\r\n                    </div>\r\n                </md-dialog-content>\r\n                <md-dialog-actions>\r\n                    <md-button ng-click=\"vm.cancel()\"\r\n                        class=\"md-primary\">Cancelar\r\n                    </md-button>\r\n                </md-dialog-actions>\r\n            </form>\r\n            <form name=\"form.deleteEntityForm\"\r\n                class=\"delete-entity-form\"\r\n                ng-submit=\"vm.borrar()\"\r\n                ng-if=\"vm.entity.type!='ROOT' && vm.borrable==true\">\r\n                <md-toolbar>\r\n                    <div class=\"md-toolbar-tools\">\r\n                        <h2>Borrar\r\n                            {{vm.attributes.nombreEntidad}}\r\n                        </h2>\r\n                        <span flex></span>\r\n                        <md-button class=\"md-icon-button\"\r\n                            ng-click=\"vm.cancel()\">\r\n                            <ng-md-icon icon=\"close\"\r\n                                aria-label=\"Close\">\r\n                            </ng-md-icon>\r\n                        </md-button>\r\n                    </div>\r\n                </md-toolbar>\r\n                <md-dialog-content>\r\n                    <div class=\"md-dialog-content\">\r\n                        Esta operación no es reversible.\r\n                    </div>\r\n                </md-dialog-content>\r\n                <md-dialog-actions>\r\n                    <md-button type=\"submit\"\r\n                        class=\"md-primary\">Borrar\r\n                    </md-button>\r\n                    <md-button ng-click=\"vm.cancel()\"\r\n                        class=\"md-raised md-primary\">\r\n                        Cancelar\r\n                    </md-button>\r\n                </md-dialog-actions>\r\n            </form>\r\n        </md-tab>\r\n    </md-tabs>\r\n</md-dialog>\r\n\r\n<!--=======================================================================-->\r\n<!--=====  There are two example templates: for edit and add entity   =====-->\r\n<!--=======================================================================-->\r\n<!--========================  Edit entity example  ========================-->\r\n<!--=======================================================================-->\r\n<!-- -->\r\n<!--<md-dialog aria-label=\"Edit entity\">-->\r\n<!--    <form name=\"editEntityForm\" class=\"edit-entity-form\" ng-submit=\"vm.save()\">-->\r\n<!--        <md-toolbar>-->\r\n<!--            <div class=\"md-toolbar-tools\">-->\r\n<!--                <h2>Edit {{vm.entityType.toLowerCase()}} {{vm.entityName}}</h2>-->\r\n<!--                <span flex></span>-->\r\n<!--                <md-button class=\"md-icon-button\" ng-click=\"vm.cancel()\">-->\r\n<!--                    <ng-md-icon icon=\"close\" aria-label=\"Close\"></ng-md-icon>-->\r\n<!--                </md-button>-->\r\n<!--            </div>-->\r\n<!--        </md-toolbar>-->\r\n<!--        <md-dialog-content>-->\r\n<!--            <div class=\"md-dialog-content\">-->\r\n<!--                <div layout=\"row\">-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Entity Name</label>-->\r\n<!--                        <input ng-model=\"vm.entityName\" readonly>-->\r\n<!--                    </md-input-container>-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Entity Type</label>-->\r\n<!--                        <input ng-model=\"vm.entityType\" readonly>-->\r\n<!--                    </md-input-container>-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Type</label>-->\r\n<!--                        <input ng-model=\"vm.type\" readonly>-->\r\n<!--                    </md-input-container>-->\r\n<!--                </div>-->\r\n<!--                <div layout=\"row\">-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Latitude</label>-->\r\n<!--                        <input name=\"latitude\" type=\"number\" step=\"any\" ng-model=\"vm.attributes.latitude\">-->\r\n<!--                    </md-input-container>-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Longitude</label>-->\r\n<!--                        <input name=\"longitude\" type=\"number\" step=\"any\" ng-model=\"vm.attributes.longitude\">-->\r\n<!--                    </md-input-container>-->\r\n<!--                </div>-->\r\n<!--                 <div layout=\"row\">-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Address</label>-->\r\n<!--                        <input ng-model=\"vm.attributes.address\">-->\r\n<!--                    </md-input-container>-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Owner</label>-->\r\n<!--                        <input ng-model=\"vm.attributes.owner\">-->\r\n<!--                    </md-input-container>-->\r\n<!--                </div>-->\r\n<!--                <div layout=\"row\">-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Integer Value</label>-->\r\n<!--                        <input name=\"integerNumber\" type=\"number\" step=\"1\" ng-pattern=\"/^-?[0-9]+$/\" ng-model=\"vm.attributes.number\">-->\r\n<!--                        <div ng-messages=\"editEntityForm.integerNumber.$error\">-->\r\n<!--                            <div ng-message=\"pattern\">Invalid integer value.</div>-->\r\n<!--                        </div>-->\r\n<!--                    </md-input-container>-->\r\n<!--                    <div class=\"boolean-value-input\" layout=\"column\" layout-align=\"center start\" flex>-->\r\n<!--                        <label class=\"checkbox-label\">Boolean Value</label>-->\r\n<!--                        <md-checkbox ng-model=\"vm.attributes.booleanValue\" style=\"margin-bottom: 40px;\">-->\r\n<!--                            {{ (vm.attributes.booleanValue ? \"value.true\" : \"value.false\") | translate }}-->\r\n<!--                        </md-checkbox>-->\r\n<!--                    </div>-->\r\n<!--                </div>-->\r\n<!--                <div class=\"relations-list old-relations\">-->\r\n<!--                    <div class=\"md-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">Relations</div>-->\r\n<!--                    <div class=\"body\" ng-show=\"vm.relations.length\">-->\r\n<!--                        <div class=\"row\" layout=\"row\" layout-align=\"start center\" ng-repeat=\"relation in vm.relations track by $index\">-->\r\n<!--                            <div class=\"md-whiteframe-1dp\" flex layout=\"row\" style=\"padding-left: 5px; margin-bottom: 3px;\">-->\r\n<!--                                <div flex layout=\"column\">-->\r\n<!--                                    <div layout=\"row\">-->\r\n<!--                                        <md-input-container class=\"md-block\" style=\"min-width: 100px;\">-->\r\n<!--                                            <label>Direction</label>-->\r\n<!--                                            <md-select ng-disabled=\"true\" required ng-model=\"relation.direction\">-->\r\n<!--                                                <md-option ng-repeat=\"direction in vm.entitySearchDirection\" ng-value=\"direction\">-->\r\n<!--                                                    {{ (\"relation.search-direction.\" + direction) | translate}}-->\r\n<!--                                                </md-option>-->\r\n<!--                                            </md-select>-->\r\n<!--                                        </md-input-container>-->\r\n<!--                                        <tb-relation-type-autocomplete ng-disabled=\"true\" flex class=\"md-block\"-->\r\n<!--                                           the-form=\"editEntityForm\"-->\r\n<!--                                           ng-model=\"relation.relationType\"-->\r\n<!--                                           tb-required=\"true\">-->\r\n<!--                                        </tb-relation-type-autocomplete>-->\r\n<!--                                    </div>-->\r\n<!--                                    <div layout=\"row\">-->\r\n<!--                                        <tb-entity-select flex class=\"md-block\"-->\r\n<!--                                            the-form=\"editEntityForm\"-->\r\n<!--                                            ng-disabled=\"true\"-->\r\n<!--                                            tb-required=\"true\"-->\r\n<!--                                            ng-model=\"relation.relatedEntity\">-->\r\n<!--                                        </tb-entity-select>-->\r\n<!--                                    </div>-->\r\n<!--                                </div>-->\r\n<!--                                <div layout=\"column\" layout-align=\"center center\">-->\r\n<!--                                    <md-button class=\"md-icon-button md-primary\" style=\"width: 40px; min-width: 40px;\"-->\r\n<!--                                               ng-click=\"vm.removeOldRelation($index,relation)\" aria-label=\"Remove\">-->\r\n<!--                                        <md-tooltip md-direction=\"top\">Remove relation</md-tooltip>-->\r\n<!--                                        <md-icon aria-label=\"Remove\" class=\"material-icons\">-->\r\n<!--                                            close-->\r\n<!--                                        </md-icon>-->\r\n<!--                                    </md-button>-->\r\n<!--                                </div>-->\r\n<!--                            </div>-->\r\n<!--                        </div>-->\r\n<!--                    </div>-->\r\n<!--                </div>-->\r\n<!--                <div class=\"relations-list\">-->\r\n<!--                    <div class=\"md-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">New Relations</div>-->\r\n<!--                    <div class=\"body\" ng-show=\"vm.newRelations.length\">-->\r\n<!--                        <div class=\"row\" layout=\"row\" layout-align=\"start center\" ng-repeat=\"relation in vm.newRelations track by $index\">-->\r\n<!--                            <div class=\"md-whiteframe-1dp\" flex layout=\"row\" style=\"padding-left: 5px; margin-bottom: 3px;\">-->\r\n<!--                                <div flex layout=\"column\">-->\r\n<!--                                    <div layout=\"row\">-->\r\n<!--                                        <md-input-container class=\"md-block\" style=\"min-width: 100px;\">-->\r\n<!--                                            <label>Direction</label>-->\r\n<!--                                            <md-select name=\"direction\" required ng-model=\"relation.direction\">-->\r\n<!--                                                <md-option ng-repeat=\"direction in vm.entitySearchDirection\" ng-value=\"direction\">-->\r\n<!--                                                    {{ (\"relation.search-direction.\" + direction) | translate}}-->\r\n<!--                                                </md-option>-->\r\n<!--                                            </md-select>-->\r\n<!--                                            <div ng-messages=\"editEntityForm.direction.$error\">-->\r\n<!--                                                <div ng-message=\"required\">Relation direction is required.</div>-->\r\n<!--                                            </div>-->\r\n<!--                                        </md-input-container>-->\r\n<!--                                        <tb-relation-type-autocomplete flex class=\"md-block\"-->\r\n<!--                                           the-form=\"editEntityForm\"-->\r\n<!--                                           ng-model=\"relation.relationType\"-->\r\n<!--                                           tb-required=\"true\">-->\r\n<!--                                        </tb-relation-type-autocomplete>-->\r\n<!--                                    </div>-->\r\n<!--                                    <div layout=\"row\">-->\r\n<!--                                        <tb-entity-select flex class=\"md-block\"-->\r\n<!--                                            the-form=\"editEntityForm\"-->\r\n<!--                                            tb-required=\"true\"-->\r\n<!--                                            ng-model=\"relation.relatedEntity\">-->\r\n<!--                                        </tb-entity-select>-->\r\n<!--                                    </div>-->\r\n<!--                                </div>-->\r\n<!--                                <div layout=\"column\" layout-align=\"center center\">-->\r\n<!--                                    <md-button class=\"md-icon-button md-primary\" style=\"width: 40px; min-width: 40px;\"-->\r\n<!--                                               ng-click=\"vm.removeRelation($index)\" aria-label=\"Remove\">-->\r\n<!--                                        <md-tooltip md-direction=\"top\">Remove relation</md-tooltip>-->\r\n<!--                                        <md-icon aria-label=\"Remove\" class=\"material-icons\">-->\r\n<!--                                            close-->\r\n<!--                                        </md-icon>-->\r\n<!--                                    </md-button>-->\r\n<!--                                </div>-->\r\n<!--                            </div>-->\r\n<!--                        </div>-->\r\n<!--                    </div>-->\r\n<!--                   <div>-->\r\n<!--                       <md-button class=\"md-primary md-raised\" ng-click=\"vm.addRelation()\" aria-label=\"Add\">-->\r\n<!--                           <md-tooltip md-direction=\"top\">Add Relation</md-tooltip>-->\r\n<!--                           Add-->\r\n<!--                       </md-button>-->\r\n<!--                   </div> -->\r\n<!--                </div>-->\r\n<!--            </div>-->\r\n<!--        </md-dialog-content>-->\r\n<!--        <md-dialog-actions>-->\r\n<!--            <md-button type=\"submit\" ng-disabled=\"editEntityForm.$invalid || !editEntityForm.$dirty\" class=\"md-raised md-primary\">Save</md-button>-->\r\n<!--            <md-button ng-click=\"vm.cancel()\" class=\"md-primary\">Cancel</md-button>-->\r\n<!--        </md-dialog-actions>-->\r\n<!--    </form>-->\r\n<!--</md-dialog>-->\r\n<!---->\r\n<!--========================================================================-->\r\n<!--=========================  Add entity example  =========================-->\r\n<!--========================================================================-->\r\n<!---->\r\n<!--<md-dialog aria-label=\"Add entity\">-->\r\n<!--    <form name=\"addEntityForm\" class=\"add-entity-form\" ng-submit=\"vm.save()\">-->\r\n<!--        <md-toolbar>-->\r\n<!--            <div class=\"md-toolbar-tools\">-->\r\n<!--                <h2>Add entity</h2>-->\r\n<!--                <span flex></span>-->\r\n<!--                <md-button class=\"md-icon-button\" ng-click=\"vm.cancel()\">-->\r\n<!--                    <ng-md-icon icon=\"close\" aria-label=\"Close\"></ng-md-icon>-->\r\n<!--                </md-button>-->\r\n<!--            </div>-->\r\n<!--        </md-toolbar>-->\r\n<!--        <md-dialog-content>-->\r\n<!--            <div class=\"md-dialog-content\">-->\r\n<!--                <div layout=\"row\">-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Entity Name</label>-->\r\n<!--                        <input ng-model=\"vm.entityName\" name=entityName required>-->\r\n<!--                        <div ng-messages=\"addEntityForm.entityName.$error\">-->\r\n<!--                            <div ng-message=\"required\">Entity name is required.</div>-->\r\n<!--                        </div>-->\r\n<!--                    </md-input-container>-->\r\n<!--                    <tb-entity-type-select class=\"md-block\" style=\"min-width: 100px; width: 100px;\"-->\r\n<!--                       the-form=\"addEntityForm\"-->\r\n<!--                       tb-required=\"true\"-->\r\n<!--                       allowed-entity-types=\"vm.allowedEntityTypes\"-->\r\n<!--                       ng-model=\"vm.entityType\">-->\r\n<!--                    </tb-entity-type-select>-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Entity Subtype</label>-->\r\n<!--                        <input ng-model=\"vm.type\" name=type required>-->\r\n<!--                        <div ng-messages=\"addEntityForm.type.$error\">-->\r\n<!--                            <div ng-message=\"required\">Entity subtype is required.</div>-->\r\n<!--                        </div>-->\r\n<!--                    </md-input-container>-->\r\n<!--                </div>-->\r\n<!--                <div layout=\"row\">-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Latitude</label>-->\r\n<!--                        <input name=\"latitude\" type=\"number\" step=\"any\" ng-model=\"vm.attributes.latitude\">-->\r\n<!--                    </md-input-container>-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Longitude</label>-->\r\n<!--                        <input name=\"longitude\" type=\"number\" step=\"any\" ng-model=\"vm.attributes.longitude\">-->\r\n<!--                    </md-input-container>-->\r\n<!--                </div>-->\r\n<!--                 <div layout=\"row\">-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Address</label>-->\r\n<!--                        <input ng-model=\"vm.attributes.address\">-->\r\n<!--                    </md-input-container>-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Owner</label>-->\r\n<!--                        <input ng-model=\"vm.attributes.owner\">-->\r\n<!--                    </md-input-container>-->\r\n<!--                </div>-->\r\n<!--                <div layout=\"row\">-->\r\n<!--                    <md-input-container flex class=\"md-block\">-->\r\n<!--                        <label>Integer Value</label>-->\r\n<!--                        <input name=\"integerNumber\" type=\"number\" step=\"1\" ng-pattern=\"/^-?[0-9]+$/\" ng-model=\"vm.attributes.number\">-->\r\n<!--                        <div ng-messages=\"addEntityForm.integerNumber.$error\">-->\r\n<!--                            <div ng-message=\"pattern\">Invalid integer value.</div>-->\r\n<!--                        </div>-->\r\n<!--                    </md-input-container>-->\r\n<!--                    <div class=\"boolean-value-input\" layout=\"column\" layout-align=\"center start\" flex>-->\r\n<!--                        <label class=\"checkbox-label\">Boolean Value</label>-->\r\n<!--                        <md-checkbox ng-model=\"vm.attributes.booleanValue\" style=\"margin-bottom: 40px;\">-->\r\n<!--                            {{ (vm.attributes.booleanValue ? \"value.true\" : \"value.false\") | translate }}-->\r\n<!--                        </md-checkbox>-->\r\n<!--                    </div>-->\r\n<!--                </div>-->\r\n<!--                <div class=\"relations-list\">-->\r\n<!--                    <div class=\"md-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">Relations</div>-->\r\n<!--                    <div class=\"body\" ng-show=\"vm.relations.length\">-->\r\n<!--                        <div class=\"row\" layout=\"row\" layout-align=\"start center\" ng-repeat=\"relation in vm.relations track by $index\">-->\r\n<!--                            <div class=\"md-whiteframe-1dp\" flex layout=\"row\" style=\"padding-left: 5px;\">-->\r\n<!--                                <div flex layout=\"column\">-->\r\n<!--                                    <div layout=\"row\">-->\r\n<!--                                        <md-input-container class=\"md-block\" style=\"min-width: 100px;\">-->\r\n<!--                                            <label>Direction</label>-->\r\n<!--                                            <md-select name=\"direction\" required ng-model=\"relation.direction\">-->\r\n<!--                                                <md-option ng-repeat=\"direction in vm.entitySearchDirection\" ng-value=\"direction\">-->\r\n<!--                                                    {{ (\"relation.search-direction.\" + direction) | translate}}-->\r\n<!--                                                </md-option>-->\r\n<!--                                            </md-select>-->\r\n<!--                                            <div ng-messages=\"addEntityForm.direction.$error\">-->\r\n<!--                                                <div ng-message=\"required\">Relation direction is required.</div>-->\r\n<!--                                            </div>-->\r\n<!--                                        </md-input-container>-->\r\n<!--                                        <tb-relation-type-autocomplete flex class=\"md-block\"-->\r\n<!--                                           the-form=\"addEntityForm\"-->\r\n<!--                                           ng-model=\"relation.relationType\"-->\r\n<!--                                           tb-required=\"true\">-->\r\n<!--                                        </tb-relation-type-autocomplete>-->\r\n<!--                                    </div>-->\r\n<!--                                    <div layout=\"row\">-->\r\n<!--                                        <tb-entity-select flex class=\"md-block\"-->\r\n<!--                                            the-form=\"addEntityForm\"-->\r\n<!--                                            tb-required=\"true\"-->\r\n<!--                                            ng-model=\"relation.relatedEntity\">-->\r\n<!--                                        </tb-entity-select>-->\r\n<!--                                    </div>-->\r\n<!--                                </div>-->\r\n<!--                                <div layout=\"column\" layout-align=\"center center\">-->\r\n<!--                                    <md-button class=\"md-icon-button md-primary\" style=\"width: 40px; min-width: 40px;\"-->\r\n<!--                                               ng-click=\"vm.removeRelation($index)\" aria-label=\"Remove\">-->\r\n<!--                                        <md-tooltip md-direction=\"top\">Remove relation</md-tooltip>-->\r\n<!--                                        <md-icon aria-label=\"Remove\" class=\"material-icons\">-->\r\n<!--                                            close-->\r\n<!--                                        </md-icon>-->\r\n<!--                                    </md-button>-->\r\n<!--                                </div>-->\r\n<!--                            </div>-->\r\n<!--                        </div>-->\r\n<!--                    </div>-->\r\n<!--                   <div>-->\r\n<!--                       <md-button class=\"md-primary md-raised\" ng-click=\"vm.addRelation()\" aria-label=\"Add\">-->\r\n<!--                           <md-tooltip md-direction=\"top\">Add Relation</md-tooltip>-->\r\n<!--                           Add-->\r\n<!--                       </md-button>-->\r\n<!--                   </div> -->\r\n<!--                </div>-->\r\n<!--            </div>-->\r\n<!--        </md-dialog-content>-->\r\n<!--        <md-dialog-actions>-->\r\n<!--            <md-button type=\"submit\" ng-disabled=\"addEntityForm.$invalid || !addEntityForm.$dirty\" class=\"md-raised md-primary\">Create</md-button>-->\r\n<!--            <md-button ng-click=\"vm.cancel()\" class=\"md-primary\">Cancel</md-button>-->\r\n<!--        </md-dialog-actions>-->\r\n<!--    </form>-->\r\n<!--</md-dialog>-->",
                "customCss": "/*=======================================================================*/\n/*==========  There are two examples: for edit and add entity  ==========*/\n/*=======================================================================*/\n/*========================  Edit entity example  ========================*/\n/*=======================================================================*/\n/*\n.edit-entity-form md-input-container {\n    padding-right: 10px;\n}\n\n.edit-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.edit-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body md-autocomplete-wrap md-input-container {\n    height: 30px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n\n.relations-list.old-relations tb-entity-select tb-entity-autocomplete button {\n    display: none;\n} \n*/\n/*========================================================================*/\n/*=========================  Add entity example  =========================*/\n/*========================================================================*/\n/*\n.add-entity-form md-input-container {\n    padding-right: 10px;\n}\n\n.add-entity-form .boolean-value-input {\n    padding-left: 5px;\n}\n\n.add-entity-form .boolean-value-input .checkbox-label {\n    margin-bottom: 8px;\n    color: rgba(0,0,0,0.54);\n    font-size: 12px;\n}\n\n.relations-list .header {\n    padding-right: 5px;\n    padding-bottom: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .header .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n    font-size: 12px;\n    font-weight: 700;\n    color: rgba(0, 0, 0, .54);\n    white-space: nowrap;\n}\n\n.relations-list .body {\n    padding-right: 5px;\n    padding-bottom: 15px;\n    padding-left: 5px;\n}\n\n.relations-list .body .row {\n    padding-top: 5px;\n}\n\n.relations-list .body .cell {\n    padding-right: 5px;\n    padding-left: 5px;\n}\n\n.relations-list .body md-autocomplete-wrap md-input-container {\n    height: 30px;\n}\n\n.relations-list .body .md-button {\n    margin: 0;\n}\n*/\n",
                "customFunction": "var b64array =\n    \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n\nfunction utf8_encode(string) {\n    string = string.replace(/\\r\\n/g, \"\\n\");\n    var utftext = \"\";\n\n    for (var n = 0; n < string.length; n++) {\n\n        var c = string.charCodeAt(n);\n\n        if (c < 128) {\n            utftext += String.fromCharCode(c);\n        } else if ((c > 127) && (c < 2048)) {\n            utftext += String.fromCharCode((c >> 6) | 192);\n            utftext += String.fromCharCode((c & 63) | 128);\n        } else {\n            utftext += String.fromCharCode((c >> 12) | 224);\n            utftext += String.fromCharCode(((c >> 6) & 63) |\n                128);\n            utftext += String.fromCharCode((c & 63) | 128);\n        }\n\n    }\n\n    return utftext;\n}\n\nfunction encodeBase64(input) {\n    var output = \"\";\n    var chr1, chr2, chr3, enc1, enc2, enc3, enc4;\n    var i = 0;\n\n    input = utf8_encode(input);\n\n    while (i < input.length) {\n\n        chr1 = input.charCodeAt(i++);\n        chr2 = input.charCodeAt(i++);\n        chr3 = input.charCodeAt(i++);\n\n        enc1 = chr1 >> 2;\n        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);\n        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);\n        enc4 = chr3 & 63;\n\n        if (isNaN(chr2)) {\n            enc3 = enc4 = 64;\n        } else if (isNaN(chr3)) {\n            enc4 = 64;\n        }\n\n        output = output +\n            b64array.charAt(enc1) + b64array.charAt(enc2) +\n            b64array.charAt(enc3) + b64array.charAt(enc4);\n\n    }\n\n    return output;\n}\n\n\nvar $injector = widgetContext.$scope.$injector;\nvar $mdDialog = $injector.get('$mdDialog'),\n    $document = $injector.get('$document'),\n    $location = $injector.get('$location'),\n    $q = $injector.get('$q'),\n    types = $injector.get('types'),\n    $rootScope = $injector.get('$rootScope'),\n    entityService = $injector.get('entityService'),\n    attributeService = $injector.get('attributeService'),\n    assetService = $injector.get('assetService'),\n    userService = $injector.get('userService'),\n    deviceService = $injector.get('deviceService'),\n    servicioHTTP = $injector.get(\n        '$http'),\n    entityRelationService = $injector.get(\n        'entityRelationService');\n\n//Obtengo el código de configuración del tipo de nodo\nvar notificaciones =\n    '<md-card> Notificaciones <md-card> <label class=\"checkbox-label\">Habilitadas temporalmente</label> <md-checkbox ng-disabled=\"!vm.configuracion.__alarmas.cambioDeEstado.enable\"  ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.habilitacionTemporal\" style=\"margin-bottom: 10px;\" > {{ (vm.configuracion.__alarmas.cambioDeEstado.habilitacionTemporal ? \"value.true\" : \"value.false\") | translate }} </md-checkbox> <md-card ng-if=\"vm.configuracion.__alarmas.cambioDeEstado.habilitacionTemporal\"> <label class=\"checkbox-label\">Programación horaria</label> <md-checkbox ng-disabled=\"!vm.configuracion.__alarmas.cambioDeEstado.enable\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.programacionHoraria\" style=\"margin-bottom: 10px;\"> {{ (vm.configuracion.__alarmas.cambioDeEstado.programacionHoraria ? \"value.true\" : \"value.false\") | translate }} </md-checkbox> <md-card ng-if=\"vm.configuracion.__alarmas.cambioDeEstado.programacionHoraria\"> <table> <tr> <td> <label>0<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[0]\" /></label> </td> <td> <label>1<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[1]\" /></label> </td> <td> <label>2<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[2]\" /></label> </td> <td> <label>3<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[3]\" /></label> </td> <td> <label>4<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[4]\" /></label> </td> <td> <label>5<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[5]\" /></label> </td> </tr> <tr> <td> <label>6<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[6]\" /></label> </td> <td> <label>7<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[7]\" /></label> </td> <td> <label>8<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[8]\" /></label> </td> <td> <label>9<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[9]\" /></label> </td> <td> <label>10<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[10]\" /></label> </td> <td> <label>11<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[11]\" /></label> </td> </tr> <tr> <td> <label>12<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[12]\" /></label> </td> <td> <label>13<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[13]\" /></label> </td> <td> <label>14<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[14]\" /></label> </td> <td> <label>15<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[15]\" /></label> </td> <td> <label>16<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[16]\" /></label> </td> <td> <label>17<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[17]\" /></label> </td> </tr> <tr> <td> <label>18<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[18]\" /></label> </td> <td> <label>19<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[19]\" /></label> </td> <td> <label>20<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[20]\" /></label> </td> <td> <label>21<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[21]\" /></label> </td> <td> <label>22<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[22]\" /></label> </td> <td> <label>23<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.horas[23]\" /></label> </td> </tr> </table> </md-card> </md-card> <md-card ng-if=\"vm.configuracion.__alarmas.cambioDeEstado.habilitacionTemporal\"> <label class=\"checkbox-label\">Programación semanal</label> <md-checkbox ng-disabled=\"!vm.configuracion.__alarmas.cambioDeEstado.enable\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.programacionSemanal\" style=\"margin-bottom: 10px;\"> {{ (vm.configuracion.__alarmas.cambioDeEstado.programacionSemanal ? \"value.true\" : \"value.false\") | translate }} </md-checkbox> <md-card ng-if=\"vm.configuracion.__alarmas.cambioDeEstado.programacionSemanal\"> <table> <tr> <td> <label>Lun<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.dias[0]\" /></label> </td> <td> <label>Mar<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.dias[1]\" /></label> </td> <td> <label>Mie<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.dias[2]\" /></label> </td> <td> <label>Jue<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.dias[3]\" /></label> </td> <td> <label>Vie<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.dias[4]\" /></label> </td> <td> <label>Sab<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.dias[5]\" /></label> </td> <td> <label>Dom<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.dias[6]\" /></label> </td> </tr> </table> </md-card> </md-card> <md-card ng-if=\"vm.configuracion.__alarmas.cambioDeEstado.habilitacionTemporal\"> <label class=\"checkbox-label\">Programación mensual</label> <md-checkbox ng-disabled=\"!vm.configuracion.__alarmas.cambioDeEstado.enable\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.programacionMensual\" style=\"margin-bottom: 10px;\"> {{ (vm.configuracion.__alarmas.cambioDeEstado.programacionMensual ? \"value.true\" : \"value.false\") | translate }} </md-checkbox> <md-card ng-if=\"vm.configuracion.__alarmas.cambioDeEstado.programacionMensual\"> <table> <tr> <td> <label>Ene<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[0]\" /></label> </td> <td> <label>Feb<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[1]\" /></label> </td> <td> <label>Mar<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[2]\" /></label> </td> <td> <label>Abr<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[3]\" /></label> </td> <td> <label>May<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[4]\" /></label> </td> <td> <label>Jun<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[5]\" /></label> </td> </tr> <tr> <td> <label>Jul<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[6]\" /></label> </td> <td> <label>Ago<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[7]\" /></label> </td> <td> <label>Sep<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[8]\" /></label> </td> <td> <label>Oct<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[9]\" /></label> </td> <td> <label>Nov<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[10]\" /></label> </td> <td> <label>Dic<input type=\"checkbox\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.meses[11]\" /></label> </td> </tr> </table> </md-card> </md-card> </md-card> <md-card ng-if=\"vm.viasNotificacion.email\"> <label class=\"checkbox-label\">email</label> <md-checkbox ng-disabled=\"!vm.configuracion.__alarmas.cambioDeEstado.enable || !vm.viasNotificacion.email\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.email\" style=\"margin-bottom: 10px;\"> {{ (vm.configuracion.__alarmas.cambioDeEstado.email ? \"value.true\" : \"value.false\") | translate }} </md-checkbox> <md-card> <label class=\"checkbox-label\">Enviar al email principal</label> <md-checkbox ng-disabled=\"!vm.configuracion.__alarmas.cambioDeEstado.enable || !vm.viasNotificacion.email\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.emailPrincipal\" style=\"margin-bottom: 10px;\"> {{ (vm.configuracion.__alarmas.cambioDeEstado.emailPrincipal ? \"value.true\" : \"value.false\") | translate }} </md-checkbox> <label>Enviar a emails adicionales</label> <md-chips ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.emailsAdicionales\" placeholder=\"Máximo 3 emails\" md-removable=\"vm.configuracion.__alarmas.cambioDeEstado.enable && vm.viasNotificacion.email && vm.configuracion.__alarmas.cambioDeEstado.email\" md-enable-chip-edit=\"vm.configuracion.__alarmas.cambioDeEstado.enable && vm.viasNotificacion.email && vm.configuracion.__alarmas.cambioDeEstado.email\" md-max-chips=\"3\" readonly=\"!vm.configuracion.__alarmas.cambioDeEstado.enable || !vm.viasNotificacion.email || !vm.configuracion.__alarmas.cambioDeEstado.email\" ></md-chips> </md-card> </md-card> <md-card ng-if=\"vm.viasNotificacion.telegram\"> <label class=\"checkbox-label\">Telegram</label> <md-checkbox ng-disabled=\"!vm.configuracion.__alarmas.cambioDeEstado.enable || !vm.viasNotificacion.telegram\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.telegram\" style=\"margin-bottom: 10px;\"> {{ (vm.configuracion.__alarmas.cambioDeEstado.telegram ? \"value.true\" : \"value.false\") | translate }} </md-checkbox> </md-card> <md-card ng-if=\"vm.viasNotificacion.ifttt\"> <div flex layout=\"column\"> <label class=\"checkbox-label\">IFTTT</label> <md-checkbox ng-disabled=\"!vm.configuracion.__alarmas.cambioDeEstado.enable || !vm.viasNotificacion.ifttt\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.ifttt\" style=\"margin-bottom: 10px;\"> {{ (vm.configuracion.__alarmas.cambioDeEstado.ifttt ? \"value.true\" : \"value.false\") | translate }} </md-checkbox> </div> <md-input-container flex class=\"md-block\"> <label>Evento IFTTT</label> <input size=\"40\" ng-disabled=\"!vm.configuracion.__alarmas.cambioDeEstado.enable || !vm.configuracion.__alarmas.cambioDeEstado.ifttt\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.iftttEvento\" ng-required=\"vm.configuracion.__alarmas.cambioDeEstado.enable && vm.configuracion.__alarmas.cambioDeEstado.ifttt\" /> </md-input-container> </md-card><md-card ng-if=\"vm.viasNotificacion.matrix\"> <label class=\"checkbox-label\">Matrix</label> <md-checkbox ng-disabled=\"!vm.configuracion.__alarmas.cambioDeEstado.enable || !vm.viasNotificacion.matrix\" ng-model=\"vm.configuracion.__alarmas.cambioDeEstado.matrix\" style=\"margin-bottom: 10px;\"> {{ (vm.configuracion.__alarmas.cambioDeEstado.matrix ? \"value.true\" : \"value.false\") | translate }} </md-checkbox> </md-card> <!--Final notificaciones--></md-card>';\n\nvar chirpstack =\n    '<div class=\"body\"> <div class=\"row\" layout=\"row\" layout-align=\"start center\"> <div class=\"md-whiteframe-1dp\" flex layout=\"column\" style=\"padding-left: 5px; margin-bottom: 3px;\"> <div class=\"md-body-1\" style=\"padding-bottom: 10px; color: rgba(0,0,0,0.57);\">ChirpStack</div><div class=\"row\" layout=\"column\"> <md-input-container flex class=\"md-block\"> <label>URL de ChirpStack</label> <input type=\"text\" size=\"30\" ng-model=\"vm.configuracion.__cs_url\" placeholder=\"https://my.iotopentech.io:8080\"/> </md-input-container><md-input-container flex class=\"md-block\"> <label>JWT ChirpStack</label> <input type=\"password\" size=\"30\" ng-model=\"vm.configuracion.__cs_token\" /> </md-input-container> </div> </div> </div></div>';\nvar coordenadas =\n    '<div class=\"md-body-1\" style=\"padding-bottom: 10px; color: rgba(0, 0, 0, 0.57);\">Coordenadas</div><div class=\"body\" style=\"margin-bottom: 25px;\"> <div class=\"row\" layout=\"row\" layout-align=\"start center\"> <div class=\"md-whiteframe-1dp\" flex layout=\"column\" style=\"padding-left: 5px; margin-bottom: 3px;\"> <div class=\"row\" layout=\"row\"> <md-radio-group ng-model=\"vm.configuracion.__tipoCoordenadas\"> <md-radio-button value=\"Imagen\">Imagen</md-radio-button> <md-radio-button value=\"Mapa\">Mapa</md-radio-button> </md-radio-group> </div> <div class=\"row\" layout=\"row\" ng-if=\"vm.configuracion.__tipoCoordenadas==\\'Imagen\\'\"> <md-input-container flex class=\"md-block\"> <label>Posicion X (expresada entre 0 y 1)</label> <input type=\"number\" size=\"10\" step=\".01\" min=\"0\" max=\"1\" ng-model=\"vm.configuracion.__xPos\" ng-required=\"vm.configuracion.__tipoCoordenadas==\\'Imagen\\'\"/> </md-input-container> <md-input-container flex class=\"md-block\"> <label>Posicion Y (expresada entre 0 y 1)</label> <input type=\"number\" size=\"10\" step=\"0.01\" min=\"0.00\" max=\"1.00\" ng-model=\"vm.configuracion.__yPos\" ng-required=\"vm.configuracion.__tipoCoordenadas==\\'Imagen\\'\"/> </md-input-container> </div> <div class=\"row\" layout=\"row\" ng-if=\"vm.configuracion.__tipoCoordenadas==\\'Mapa\\'\"> <md-input-container flex class=\"md-block\"> <label>Latitud</label> <input type=\"number\" size=\"10\" step=\"0.0001\" min=\"-90\" max=\"90\" ng-model=\"vm.configuracion.__latitude\" ng-required=\"vm.configuracion.__tipoCoordenadas==\\'Mapa\\'\"/> </md-input-container> <md-input-container flex class=\"md-block\"> <label>Longitud</label> <input type=\"number\" size=\"10\" step=\"0.0001\" min=\"-180\" max=\"180\" ng-model=\"vm.configuracion.__longitude\" ng-required=\"vm.configuracion.__tipoCoordenadas==\\'Mapa\\'\"/> </md-input-container> </div> </div> </div></div>';\n\nvar subtipo = \"\";\nvar configurable = false;\nvar urlDashboard = \"\";\n\nvar delegable = false;\nvar htmlTemplate2 = htmlTemplate;\nvar emailsAdicionales = [];\nvar allowedEntityTypes = [];\nvar funciones = [];\n/*\nif (entityId.entityType != types\n    .entityType.device) {\n    openEditEntityDialog();\n} else {\n*/\nentityService.getEntity(entityId.entityType,\n    entityId.id).then(\n    function(entity) {\n        subtipo = entity.type;\n        //console.log(subtipo);\n        attributeService.getEntityAttributesValues(\n            'CUSTOMER', userService\n            .getCurrentUser()\n            .customerId,\n            'SERVER_SCOPE').then(\n            function(data) {\n\n                if (data.length) {\n                    getConfiguracion(\n                        data);\n                }\n            });\n\n\n    });\n\n//getConfiguracion();\n//}\n\n//openEditEntityDialog();\n\nfunction getConfiguracion(attributes) {\n    for (var i = 0; i < attributes.length; i++) {\n        if (attributes[i].key ==\n            subtipo + \"_urlDashboard\") {\n            urlDashboard = attributes[i].value;\n        } else if (attributes[i].key ==\n            subtipo + \"_config\") {\n\n            configurable = true;\n            var copia = attributes[i].value;\n\n            //Extraigo las funciones\n            //No puede haber nada por delante de las funciones en el atributo config\n            funciones = copia.split('</funciones>');\n            if (funciones.length == 2) {\n                copia = funciones[\n                    1]; //Me quedo con la parte HTML\n                //Hay declaración de funciones\n                funciones = funciones[0].split(\n                    '<funciones>');\n                funciones = funciones[1];\n\n                funciones = JSON.parse(funciones);\n            }\n            var parser = new DOMParser();\n            var xmlText = new XMLSerializer();\n\n            var xmlDoc = parser.parseFromString(copia,\n                \"text/xml\");\n            var xmlDevEUI = parser.parseFromString(\n                '<panel titulo=\"Device EUI\" resumen=\"Indicar el Device EUI del dispositivo\" nombreFormulario=\"DeviceEUI\" ultimoDownlink=\"devEUI\">        <item tipo=\"atributoCompartido\" nombreAtributo=\"devEUI\" labelAtributo=\"Device EUI expresado en hexadecimal\" tipoAtributo=\"texto\">            <atributosHTML size=\"16\" maxlength=\"16\" pattern=\"[0-9a-fA-F]{16}\" autocomplete=\"off\" />        </item>    </panel>',\n                \"text/xml\");\n            myIoT = xmlDoc.documentElement;\n\n            var salida =\n                \"<md-dialog-content><div class='md-dialog-content' flex><md-expansion-panel-group>\";\n            var paneles = myIoT.children;\n\n            for (j = 0; j < paneles.length; j++) {\n                if (paneles[j].nodeName != 'panel') {\n                    //Si no es un panel lo copiamos directamente\n                    salida += xmlText.serializeToString(\n                        paneles[j]);\n                } else {\n                    if (paneles[j].hasAttribute('tipo') &&\n                        paneles[j].getAttribute('tipo') ==\n                        'devEUI') {\n                        myIoT.replaceChild(xmlDevEUI\n                            .documentElement, paneles[j]\n                        );\n                    }\n                    salida +=\n                        '<md-expansion-panel ';\n                    //Gestionar si tiene permiso para ver el panel \n                    if (paneles[j].hasAttribute(\n                            'ultimoDownlink')) {\n                        salida +=\n                            'ng-if=\"!vm.attributes.hasOwnProperty(\\'esDelegado\\') || (vm.attributes.esDelegado===false)||(vm.attributes.esDelegado===true && vm.attributes.delegacion.hasOwnProperty(\\'';\n                        var ultimoDownlinkPanel = paneles[\n                                j]\n                            .getAttribute(\n                                'ultimoDownlink'\n                            );\n\n                        salida +=\n                            ultimoDownlinkPanel;\n                        salida +=\n                            '\\') && vm.attributes.delegacion.';\n                        salida +=\n                            ultimoDownlinkPanel;\n                        salida +=\n                            '===true)\"';\n                    }\n\n\n                    salida +=\n                        '><md-expansion-panel-collapsed><div class=\"md-title\">';\n                    salida += paneles[j].getAttribute(\n                        'titulo');\n                    salida +=\n                        '</div><div class=\"md-summary\">';\n                    salida += paneles[j].getAttribute(\n                        'resumen');\n                    salida +=\n                        '</div><md-expansion-panel-icon></md-expansion-panel-icon></md-expansion-panel-collapsed><md-expansion-panel-expanded><md-expansion-panel-header ng-click=\"$panel.collapse()\"><div class=\"md-title\">';\n                    salida += paneles[j].getAttribute(\n                        'titulo');\n                    salida +=\n                        '</div><div class=\"md-summary\">';\n                    salida += paneles[j].getAttribute(\n                        'resumen');\n                    salida +=\n                        '</div><md-expansion-panel-icon></md-expansion-panel-icon></md-expansion-panel-header><md-expansion-panel-content><form class=\"configure-entity-form\" ng-submit=\"vm.configurar()\" name=\"form.configuracion' +\n                        paneles[j].getAttribute(\n                            'nombreFormulario');\n\n                    salida += '\">';\n\n                    var items = paneles[j]\n                        .children;\n\n                    for (k = 0; k < items.length; k++) {\n                        if (items[k].nodeName != 'item') {\n                            //Si no es un item lo copiamos directamente\n                            salida += xmlText\n                                .serializeToString(\n                                    items[k]);\n                        } else {\n                            var tipoItem = items[k]\n                                .getAttribute(\n                                    'tipo');\n                            switch (tipoItem) {\n                                case 'alarma ad-hoc':\n                                    //Copia el HTML tal cual pero le añade las notificaciones al final\n                                    nombreAlarma =\n                                        items[k]\n                                        .getAttribute(\n                                            'nombreAlarma'\n                                        );\n                                    labelAlarma =\n                                        items[k]\n                                        .getAttribute(\n                                            'labelAlarma'\n                                        );\n                                    salida +=\n                                        '<div class=\"body md-whiteframe-1dp\" style=\"margin-bottom: 25px;\" ng-if=\"!vm.attributes.hasOwnProperty(\\'esDelegado\\') || (vm.attributes.esDelegado===false)||(vm.attributes.esDelegado===true && vm.attributes.delegacion.hasOwnProperty(\\'' +\n                                        nombreAlarma +\n                                        '\\')&& vm.attributes.delegacion.' +\n                                        nombreAlarma +\n                                        '===true)\"><label class=\"checkbox-label\">Activar alarma de ' +\n                                        labelAlarma +\n                                        '</label><md-checkbox ng-model=\"vm.configuracion.__alarmas.' +\n                                        nombreAlarma +\n                                        '.enable\" style=\"margin-bottom: 10px;\">{{(vm.configuracion.__alarmas.' +\n                                        nombreAlarma +\n                                        '.enable ? \"value.true\" : \"value.false\") | translate}}</md-checkbox><md-content class=\"md-padding\" layout-xs=\"column\" layout=\"row\"><div class=\"flex-xs\" flex-gt-xs=\"50\" layout=\"column\">';\n\n                                    salida += xmlText\n                                        .serializeToString(\n                                            items[k]\n                                            .firstElementChild\n                                        );\n\n                                    //notificaciones\n                                    salida +=\n                                        '</div><div flex-xs flex-gt-xs=\"50\" layout=\"column\">';\n                                    salida\n                                        +=\n                                        notificaciones\n                                        .replace(\n                                            /cambioDeEstado/g,\n                                            nombreAlarma\n                                        );\n                                    //El modificador /g de replace sustituye todas las ocurrencias\n                                    salida\n                                        +=\n                                        '</div></md-content></div>';\n                                    break;\n                                case 'coordenadas':\n                                    salida += coordenadas;\n                                    break;\n                                case 'chirpstack':\n                                    salida += chirpstack;\n                                    break;\n                                case 'alarma':\n                                    if (items[k]\n                                        .hasAttribute(\n                                            'telemetria')) {\n                                        salida +=\n                                            '<div class=\"body md-whiteframe-1dp\" style=\"margin-bottom: 25px;\" ng-if=\"!vm.attributes.hasOwnProperty(\\'esDelegado\\') || (vm.attributes.esDelegado===false)||(vm.attributes.esDelegado===true && vm.attributes.delegacion.hasOwnProperty(\\'';\n                                        telemetria = items[\n                                                k]\n                                            .getAttribute(\n                                                'telemetria'\n                                            );\n                                        nombreAlarma =\n                                            items[k]\n                                            .getAttribute(\n                                                'nombreAlarma'\n                                            );\n                                        salida +=\n                                            telemetria;\n                                        salida +=\n                                            '\\') && vm.attributes.delegacion.';\n                                        salida +=\n                                            telemetria;\n                                        salida +=\n                                            '===true)\">';\n                                        salida +=\n                                            '<label class=\"checkbox-label\">';\n                                        salida +=\n                                            \"Activar alarma de \" +\n                                            items[k]\n                                            .getAttribute(\n                                                'labelAlarma'\n                                            );\n                                        salida +=\n                                            '</label><md-checkbox ng-model=\"vm.configuracion.__alarmas.';\n                                        salida +=\n                                            nombreAlarma;\n                                        salida +=\n                                            '.enable\" style=\"margin-bottom: 10px;\">{{(vm.configuracion.__alarmas.';\n                                        salida +=\n                                            nombreAlarma;\n                                        salida +=\n                                            '.enable ? \"value.true\" : \"value.false\") | translate}}</md-checkbox>';\n                                        salida +=\n                                            '<md-content class=\"md-padding\" layout-xs=\"column\" layout=\"row\"><div flex-xs flex-gt-xs=\"50\" layout=\"column\">';\n\n                                        switch (items[k]\n                                            .getAttribute(\n                                                'tipoAlarma'\n                                            )) {\n                                            case 'opciones':\n                                                salida +=\n                                                    '<md-card><div flex layout=\"column\"><md-input-container flex class=\"md-block\"><label>';\n                                                salida +=\n                                                    items[\n                                                        k]\n                                                    .getAttribute(\n                                                        'labelAuxAlarma'\n                                                    );\n                                                salida +=\n                                                    '</label><md-select ng-disabled=\"!vm.configuracion.__alarmas.';\n                                                salida +=\n                                                    nombreAlarma;\n                                                salida +=\n                                                    '.enable\" ng-required=\"vm.configuracion.__alarmas.';\n                                                salida +=\n                                                    nombreAlarma;\n                                                salida +=\n                                                    '.enable\" ng-model=\"vm.configuracion.__alarmas.';\n                                                salida +=\n                                                    nombreAlarma;\n                                                salida +=\n                                                    '.trigger\">';\n                                                opciones =\n                                                    items[\n                                                        k]\n                                                    .getAttribute(\n                                                        'opciones'\n                                                    ).split(\n                                                        '/'\n                                                    );\n                                                for (var opcion of\n                                                        opciones) {\n                                                    salida\n                                                        +=\n                                                        '<md-option value=\"';\n                                                    salida\n                                                        +=\n                                                        opcion;\n                                                    salida\n                                                        +=\n                                                        '\">';\n                                                    salida\n                                                        +=\n                                                        opcion;\n                                                    salida\n                                                        +=\n                                                        '</md-option>';\n                                                }\n                                                salida +=\n                                                    '</md-select></md-input-container></div></md-card>';\n\n                                                break;\n                                            case 'umbralMinimo':\n                                            case 'umbralMaximo':\n                                            case 'biUmbral':\n\n                                                if (items[k]\n                                                    .getAttribute(\n                                                        'tipoAlarma'\n                                                    ) ==\n                                                    'umbralMinimo'\n                                                ) {\n                                                    umbrales\n                                                        = [\n                                                            'Minimo'\n                                                        ];\n                                                } else if (\n                                                    items[k]\n                                                    .getAttribute(\n                                                        'tipoAlarma'\n                                                    ) ==\n                                                    'umbralMaximo'\n                                                ) {\n                                                    umbrales\n                                                        = [\n                                                            'Maximo'\n                                                        ];\n                                                } else {\n                                                    umbrales\n                                                        = ['Minimo',\n                                                            'Maximo'\n                                                        ];\n                                                }\n\n                                                if (items[k]\n                                                    .hasAttribute(\n                                                        'histeresis'\n                                                    )\n                                                ) {\n                                                    if (items[\n                                                            k\n                                                        ]\n                                                        .getAttribute(\n                                                            'histeresis'\n                                                        ) ==\n                                                        'min'\n                                                    ) {\n                                                        histeresis\n                                                            = {\n                                                                'Minimo': true,\n                                                                'Maximo': false\n                                                            }\n                                                    } else if (\n                                                        items[\n                                                            k\n                                                        ]\n                                                        .getAttribute(\n                                                            'histeresis'\n                                                        ) ==\n                                                        'max'\n                                                    ) {\n                                                        histeresis\n                                                            = {\n                                                                'Minimo': false,\n                                                                'Maximo': true\n                                                            };\n\n\n                                                    } else if (\n                                                        items[\n                                                            k\n                                                        ]\n                                                        .getAttribute(\n                                                            'histeresis'\n                                                        ) ==\n                                                        'bi'\n                                                    ) {\n                                                        histeresis\n                                                            = {\n                                                                'Minimo': true,\n                                                                'Maximo': true\n                                                            }\n                                                    } else {\n                                                        histeresis\n                                                            = {\n                                                                'Minimo': false,\n                                                                'Maximo': false\n                                                            };\n                                                    }\n                                                } else {\n                                                    histeresis\n                                                        = {\n                                                            'Minimo': false,\n                                                            'Maximo': false\n                                                        };\n                                                }\n\n                                                for (var p =\n                                                        0; p <\n                                                    umbrales\n                                                    .length; p++\n                                                ) {\n                                                    umbral =\n                                                        umbrales[\n                                                            p\n                                                        ];\n                                                    console\n                                                        .log(\n                                                            umbral\n                                                        );\n                                                    salida\n                                                        +=\n                                                        '<md-card><div flex layout=\"column\"><md-input-container flex class=\"md-block\">';\n                                                    salida\n                                                        +=\n                                                        '<label>Umbral ' +\n                                                        (umbral ==\n                                                            'Minimo' ?\n                                                            'mínimo ' :\n                                                            'máximo '\n                                                        );\n                                                    salida\n                                                        +=\n                                                        items[\n                                                            k\n                                                        ]\n                                                        .getAttribute(\n                                                            'labelAuxAlarma'\n                                                        );\n                                                    salida\n                                                        +=\n                                                        '</label> <input type=\"number\" ng-disabled=\"!vm.configuracion.__alarmas.' +\n                                                        nombreAlarma +\n                                                        '.enable \" ng-model=\"vm.configuracion.__alarmas.' +\n                                                        nombreAlarma +\n                                                        '.umbral' +\n                                                        umbral +\n                                                        '\" ng-required=\"vm.configuracion.__alarmas.' +\n                                                        nombreAlarma +\n                                                        '\"';\n                                                    //Atributos HTML\n                                                    if (items[\n                                                            k\n                                                        ]\n                                                        .getElementsByTagName(\n                                                            \"umbral\" +\n                                                            umbral\n                                                        )\n                                                        .length ==\n                                                        1\n                                                    ) {\n                                                        var atributosComodin =\n                                                            items[\n                                                                k\n                                                            ]\n                                                            .getElementsByTagName(\n                                                                \"umbral\" +\n                                                                umbral\n                                                            )[\n                                                                0\n                                                            ]\n                                                            .attributes;\n                                                        for (\n                                                            var n =\n                                                                0; n <\n                                                            atributosComodin\n                                                            .length; n++\n                                                        ) {\n                                                            salida\n                                                                +=\n                                                                atributosComodin\n                                                                .item(\n                                                                    n\n                                                                )\n                                                                .nodeName +\n                                                                '=\"' +\n                                                                atributosComodin\n                                                                .item(\n                                                                    n\n                                                                )\n                                                                .nodeValue +\n                                                                '\" ';\n                                                        }\n                                                    }\n\n                                                    salida\n                                                        +=\n                                                        '/> </md-input-container>';\n\n                                                    if (\n                                                        histeresis[\n                                                            umbral\n                                                        ] ===\n                                                        true\n                                                    ) {\n                                                        salida\n                                                            +=\n                                                            '<md-input-container flex class=\"md-block\"> <label>Histéresis</label> <input type=\"number\" autocomplete=\"off\" ng-disabled=\"!vm.configuracion.__alarmas.' +\n                                                            nombreAlarma +\n                                                            '.enable \" ng-model=\"vm.configuracion.__alarmas.' +\n                                                            nombreAlarma +\n                                                            '.histeresis' +\n                                                            umbral +\n                                                            '\" ng-required=\"vm.configuracion.__alarmas.' +\n                                                            nombreAlarma +\n                                                            '.enable\" ';\n\n                                                        //Atributos HTML\n                                                        if (items[\n                                                                k\n                                                            ]\n                                                            .getElementsByTagName(\n                                                                \"umbral\" +\n                                                                umbral\n                                                            )\n\n                                                            .length ==\n                                                            1\n                                                        ) {\n\n                                                            var atributosComodinHisteresis =\n                                                                items[\n                                                                    k\n                                                                ]\n                                                                .getElementsByTagName(\n                                                                    \"umbral\" +\n                                                                    umbral\n                                                                )[\n                                                                    0\n                                                                ]\n                                                                .attributes;\n\n\n                                                            for (\n                                                                var n =\n                                                                    0; n <\n                                                                atributosComodinHisteresis\n                                                                .length; n++\n                                                            ) {\n\n                                                                salida\n                                                                    +=\n                                                                    atributosComodinHisteresis\n                                                                    .item(\n                                                                        n\n                                                                    )\n                                                                    .nodeName +\n                                                                    '=\"' +\n                                                                    atributosComodinHisteresis\n                                                                    .item(\n                                                                        n\n                                                                    )\n                                                                    .nodeValue +\n                                                                    '\" ';\n                                                            }\n                                                        }\n\n\n\n                                                        salida\n                                                            +=\n                                                            '/> </md-input-container>'\n                                                    }\n\n                                                    salida\n                                                        +=\n                                                        '</div></md-card>';\n\n                                                }\n                                                break;\n\n                                        }\n                                        salida +=\n                                            '</div><div flex-xs flex-gt-xs=\"50\" layout=\"column\">';\n\n                                    } else {\n                                        //Alarma de inactividad\n                                        salida\n                                            +=\n                                            '<div class=\"body md-whiteframe-1dp\" style=\"margin-bottom: 25px;\"><label class=\"checkbox-label\">Activar alarma de inactividad</label><md-checkbox ng-model=\"vm.configuracion.__alarmas.inactividad.enable\" style=\"margin-bottom: 10px;\">{{(vm.configuracion.__alarmas.inactividad.enable ? \"value.true\" : \"value.false\") | translate}}</md-checkbox><md-content class=\"md-padding\" layout-xs=\"column\" layout=\"row\"><div flex-xs flex-gt-xs=\"50\" layout=\"column\"><md-card><div flex layout=\"column\"><md-input-container flex class=\"md-block\"><label>Umbral en segundos</label><input type=\"number\"size=\"10\" ng-disabled=\"!vm.configuracion.__alarmas.inactividad.enable \"ng-model=\"vm.configuracion.__alarmas.inactividad.umbralInactividad\" ng-required=\"vm.configuracion.__alarmas.inactividad.enable\"/></md-input-container></div></md-card></div><div flex-xs flex-gt-xs=\"50\" layout=\"column\">';\n                                        nombreAlarma\n                                            =\n                                            'inactividad';\n                                    }\n                                    //notificaciones\n                                    salida\n                                        +=\n                                        notificaciones\n                                        .replace(\n                                            /cambioDeEstado/g,\n                                            nombreAlarma\n                                        );\n                                    //El modificador /g de replace sustituye todas las ocurrencias\n                                    salida\n                                        +=\n                                        '</div></md-content></div>';\n                                    break;\n                                case 'atributoCompartido':\n                                case 'atributoInterno':\n\n                                    nombreAtributo\n                                        = items[k]\n                                        .getAttribute(\n                                            'nombreAtributo'\n                                        );\n                                    tipoAtributo\n                                        = items[k]\n                                        .getAttribute(\n                                            'tipoAtributo'\n                                        );\n                                    switch (\n                                        tipoAtributo\n                                    ) {\n                                        case 'opciones':\n                                            salida +=\n                                                '<label>' +\n                                                items[k]\n                                                .getAttribute(\n                                                    'labelAtributo'\n                                                ) +\n                                                '</label>';\n                                            salida +=\n                                                '<md-select ng-model=\"vm.configuracion.' +\n                                                (tipoItem ==\n                                                    'atributoCompartido' ?\n                                                    '___atributosCompartidos.' :\n                                                    '') +\n                                                nombreAtributo +\n                                                '\" class=\"md-no-underline\" placeholder=\"Elija una opción\">';\n                                            opciones =\n                                                items[\n                                                    k]\n                                                .getAttribute(\n                                                    'opciones'\n                                                ).split(\n                                                    '/'\n                                                );\n                                            for (var opcion of\n                                                    opciones) {\n                                                salida\n                                                    +=\n                                                    '<md-option value=\"';\n                                                salida\n                                                    +=\n                                                    opcion;\n                                                salida\n                                                    +=\n                                                    '\">';\n                                                salida\n                                                    +=\n                                                    opcion;\n                                                salida\n                                                    +=\n                                                    '</md-option>';\n                                            }\n                                            salida +=\n                                                '</md-select>';\n                                            break;\n                                        case 'texto':\n                                        case 'numero':\n\n                                            salida +=\n                                                '<md-input-container flex class=\"md-block\"><label>' +\n                                                items[k]\n                                                .getAttribute(\n                                                    'labelAtributo'\n                                                ) +\n                                                '</label>';\n\n\n                                            salida +=\n                                                '<input type=\"' +\n                                                (tipoAtributo ==\n                                                    'texto' ?\n                                                    'text' :\n                                                    'number'\n                                                ) +\n                                                '\" ng-model=\"vm.configuracion.' +\n                                                (tipoItem ==\n                                                    'atributoCompartido' ?\n                                                    '___atributosCompartidos.' :\n                                                    '') +\n                                                nombreAtributo +\n                                                '\" ';\n                                            if (items[\n                                                    k\n                                                ]\n                                                .getElementsByTagName(\n                                                    \"atributosHTML\"\n                                                ).length > 0\n                                            ) {\n                                                var atributosComodin =\n                                                    items[\n                                                        k\n                                                    ]\n                                                    .getElementsByTagName(\n                                                        \"atributosHTML\"\n                                                    )[\n                                                        0\n                                                    ]\n                                                    .attributes;\n                                                for (\n                                                    var n =\n                                                        0; n <\n                                                    atributosComodin\n                                                    .length; n++\n                                                ) {\n                                                    salida\n                                                        +=\n                                                        atributosComodin\n                                                        .item(\n                                                            n\n                                                        )\n                                                        .nodeName +\n                                                        '=\"' +\n                                                        atributosComodin\n                                                        .item(\n                                                            n\n                                                        )\n                                                        .nodeValue +\n                                                        '\" ';\n                                                }\n                                            }\n                                            salida +=\n                                                '/> </md-input-container>';\n                                            break;\n\n                                        case 'boton':\n                                            //Nada\n                                            break;\n                                    }\n                                    break;\n                            }\n                        }\n                    }\n\n                    salida +=\n                        '<md-input-container style=\"margin: 0px; margin-top: 10px;\"><md-button type=\"submit\"';\n                    if (typeof(tipoAtributo) ===\n                        'undefined' ||\n                        tipoAtributo != 'boton') {\n                        //Los de tipo botón deben estar siempre activos\n                        salida +=\n                            'ng-disabled=\"form.configuracion' +\n                            paneles[j]\n                            .getAttribute(\n                                'nombreFormulario'\n                            ) +\n                            '.$invalid || !form.configuracion' +\n                            paneles[j]\n                            .getAttribute(\n                                'nombreFormulario'\n                            ) +\n                            '.$dirty\" class=\"md-raised md-primary\"';\n                    } else {\n                        //Si es un botón lo pongo en naranja\n                        salida +=\n                            ' class=\"md-raised md-warn md-primary\"';\n                    }\n\n                    salida += (\n                            paneles[j].hasAttribute(\n                                'ultimoDownlink') ?\n                            'ng-click=\"vm.configuracion.___ultimoDownlink=\\'' +\n                            paneles[j].getAttribute(\n                                'ultimoDownlink') +\n                            '\\'\"> ' : '> ') + (paneles[j]\n                            .hasAttribute(\n                                'labelBotonSubmit') ?\n                            paneles[j]\n                            .getAttribute(\n                                'labelBotonSubmit'\n                            ) : 'Configurar') +\n                        ' </md-button> </md-input-container>';\n\n\n                    salida +=\n                        '</form></md-expansion-panel-content></md-expansion-panel-expanded></md-expansion-panel>';\n\n                }\n            }\n            salida +=\n                '</md-expansion-panel-group></div></md-dialog-content><md-dialog-actions><md-button ng-click=\"vm.cancel()\" class=\"md-primary\">Cancelar</md-button></md-dialog-actions>';\n\n\n\n//console.log(salida);\n            htmlTemplate2 = htmlTemplate2.replace(\n                '<sustituir class=\"ng-scope\"></sustituir>',\n                salida);\n\n            //console.log(salida);\n        } else if (attributes[i].key ==\n            subtipo + \"_delegate\") {\n            delegable = true;\n            var copiaDelegacion =\n                attributes[i]\n                .value;\n            var parser = new DOMParser();\n            var xmlText = new XMLSerializer();\n            var xmlDoc = parser.parseFromString(\n                copiaDelegacion,\n                \"text/xml\");\n\n            myIoT = xmlDoc.documentElement;\n            var delegaciones = myIoT.children;\n            var opcionesDelegacion = \"\";\n            for (j = 0; j < delegaciones.length; j++) {\n                if (delegaciones[j].nodeName !=\n                    'delegacion') {\n                    //Si no es un panel lo copiamos directamente\n                    opcionesDelegacion += xmlText\n                        .serializeToString(\n                            delegaciones[j]);\n                } else {\n                    var nombreDelegacion = delegaciones[j]\n                        .getAttribute('nombre');\n                    //¿Es un objeto JSON?\n                    if (nombreDelegacion.substring(0, 1) ==\n                        \"{\") {\n                        nombreDelegacion = JSON.parse(\n                            nombreDelegacion);\n                        var delegacionesAgrupadas =\n                            nombreDelegacion[Object.keys(\n                                nombreDelegacion)[0]];\n                        nombreDelegacion = Object.keys(\n                            nombreDelegacion)[0];\n                        if (delegacionesAgrupadas && Array\n                            .isArray(delegacionesAgrupadas)\n                        ) {\n                            for (var delegacionAgrupada =\n                                    0; delegacionAgrupada <\n                                delegacionesAgrupadas\n                                .length; delegacionAgrupada++\n                            ) {\n                                opcionesDelegacion +=\n                                    '<md-checkbox ng-show=\"false\" ng-model=\"vm.delegacion[$index].' +\n                                    delegacionesAgrupadas[\n                                        delegacionAgrupada\n                                    ] +\n                                    '\" ng-checked=\"vm.delegacion[$index].' +\n                                    nombreDelegacion +\n                                    '\"/>';\n                            }\n\n                        }\n\n                    }\n                    opcionesDelegacion +=\n                        '<md-checkbox ng-model=\"vm.delegacion[$index].' +\n                        nombreDelegacion +\n                        '\" style=\"margin-bottom: 10px;\" ng-checked=\"delegado.delegaciones.' +\n                        nombreDelegacion + '\" ';\n                    opcionesDelegacion += '>' +\n                        delegaciones[\n                            j].getAttribute('label') +\n                        '</md-checkbox> <br />';\n                }\n\n            }\n            var salida =\n                '<md-dialog-content> <div class=\"md-dialog-content\" flex> <md-expansion-panel-group> <md-expansion-panel md-component-id=\"panelDelegacion\" id=\"panelDelegacion\"> <md-expansion-panel-collapsed> <div class=\"md-title\" translate>Nueva delegaci&oacute;n</div> <div class=\"md-summary\">Delegar dispositivo en otro usuario</div> <md-expansion-panel-icon></md-expansion-panel-icon> </md-expansion-panel-collapsed> <md-expansion-panel-expanded> <md-expansion-panel-header ng-click=\"$panel.collapse()\"> <div class=\"md-title\" translate>Nueva delegaci&oacute;n</div> <div class=\"md-summary\">Delegar dispositivo en otro usuario</div> <md-expansion-panel-icon></md-expansion-panel-icon> </md-expansion-panel-header> <md-expansion-panel-content> <form name=\"form.crearDelegacion\" class=\"configure-entity-form\" ng-submit=\"vm.delegar()\"> <md-input-container flex class=\"md-block\"> <label>Nombre del dispositivo delegado (no puede empezar con _)</label> <input type=\"text\" size=\"30\" ng-model=\"vm.nombreDelegado\" ng-required=\"true\" pattern=\"^[^_].*\"/> </md-input-container> <md-input-container flex class=\"md-block\"> <label>Clave para reclamar el dispositivo delegado (si lo deja vacío se generará una clave automáticamente). No puede empezar por cero.</label> <input type=\"text\" size=\"30\" ng-model=\"vm.tokenDelegado\" pattern=\"^[1-9a-zA-Z][0-9a-zA-Z]*$\" placeholder=\"Sólo letras y números. No puede empezar por cero.\" /> </md-input-container> <md-input-container flex class=\"md-block\" ng-if=\"vm.attributes.tipoEntidad.split(\\'_\\').pop()!=\\'FREE\\'\"> <label>La delegación se costea a cargo del crédito del </label> <md-select ng-required=\"true\" ng-model=\"vm.delegacionPorCargoDe\"> <md-option value=\"delegador\"> Delegador (yo) </md-option> <md-option value=\"delegado\"> Delegado (usuario que reclame el dispositivo delegado) </md-option> </md-select> </md-input-container> <md-input-container flex class=\"md-block\"> <md-button type=\"submit\" ng-disabled=\"form.crearDelegacion.$invalid || !form.crearDelegacion.$dirty\" class=\"md-raised md-primary\"> Delegar </md-button> </md-input-container> </form> </md-expansion-panel-content> </md-expansion-panel-expanded> </md-expansion-panel>';\n            //Configurar la delegación pública\n            //Si la delegación pública está activada\n            salida +=\n                '<md-expansion-panel ng-if=\"vm.existeDelegacionPublica && delegado.nombre.startsWith(\\'D\\'+vm.entityName.split(\\'_\\')[0]+\\'__\\'+vm.entityId.id+\\'_publica\\')\" ng-repeat=\"delegado in vm.attributes.delegados\" md-component-id=\"panelConfiguracionDelegacion_{{$index}}\" id=\"panelConfiguracionDelegacion_{{$index}}\"> <md-expansion-panel-collapsed> <div class=\"md-title\" translate>Delegaci&oacute;n p&uacute;blica</div> <div class=\"md-summary\">Configurar la delegaci&oacute;n</div> <md-expansion-panel-icon></md-expansion-panel-icon> </md-expansion-panel-collapsed> <md-expansion-panel-expanded> <md-expansion-panel-header ng-click=\"$panel.collapse()\"> <div class=\"md-title\" translate>Delegaci&oacute;n p&uacute;blica</div> <div class=\"md-summary\">Configurar la delegaci&oacute;n</div> <md-expansion-panel-icon></md-expansion-panel-icon> </md-expansion-panel-header> <md-expansion-panel-content>';\n            salida +=\n                '<md-button class=\"md-raised md-button ng-isolate-scope md-ink-ripple\" ngclipboard=\"\" data-clipboard-action=\"copy\" data-clipboard-text=\"{{vm.urlDashboard}}&state={{vm.urlStatePublic}}\">Copiar URL del dashboard público</md-button>';\n            salida +=\n                '<form name=\"form.configurarDelegacion_{{$index}}\" class=\"configure-entity-form\" ng-submit=\"vm.configurarDelegacion(delegado.id,$index)\">';\n            salida += opcionesDelegacion;\n            salida +=\n                '<md-button type=\"submit\" ng-disabled=\"form.configurarDelegacion_{{$index}}.$invalid || !form.configurarDelegacion_{{$index}}.$dirty\" class=\"md-raised md-primary\"> Actualizar </md-button> <md-button type=\"submit\" ng-click=\"vm.delegacion[$index].borrar=true\" class=\"md-raised md-primary\"> Borrar </md-button>';\n            salida +=\n                '</form> ';\n            salida +=\n                '</md-expansion-panel-content> </md-expansion-panel-expanded> </md-expansion-panel> </md-expansion-panel-group> ';\n\n            //Si la delegación pública no está activada\n            salida +=\n                '<md-expansion-panel ng-if=\"!vm.existeDelegacionPublica\" md-component-id=\"panelConfiguracionDelegacion_publica\" id=\"panelConfiguracionDelegacion_publica\"> <md-expansion-panel-collapsed> <div class=\"md-title\" translate>Delegaci&oacute;n p&uacute;blica</div> <div class=\"md-summary\">Configurar la delegaci&oacute;n</div> <md-expansion-panel-icon></md-expansion-panel-icon> </md-expansion-panel-collapsed> <md-expansion-panel-expanded> <md-expansion-panel-header ng-click=\"$panel.collapse()\"> <div class=\"md-title\" translate>Delegaci&oacute;n p&uacute;blica</div> <div class=\"md-summary\">Configurar la delegaci&oacute;n</div> <md-expansion-panel-icon></md-expansion-panel-icon> </md-expansion-panel-header> <md-expansion-panel-content>';\n\n            salida +=\n                '<form name=\"form.configurarDelegacion_publica\" class=\"configure-entity-form\" ng-submit=\"vm.configurarDelegacion(\\'publica\\',0)\">';\n\n            salida +=\n                '<md-button type=\"submit\"  class=\"md-raised md-primary\"> Crear delegación pública </md-button>';\n            salida +=\n                '</form> ';\n            salida +=\n                '</md-expansion-panel-content> </md-expansion-panel-expanded> </md-expansion-panel> </md-expansion-panel-group> ';\n            //Fin de si la delegación pública no está activada\n\n            //Configurar el resto de delegaciones\n            salida +=\n                '<md-expansion-panel ng-if=\"!delegado.nombre.startsWith(\\'D\\'+vm.entityName.split(\\'_\\')[0]+\\'__\\'+vm.entityId.id+\\'_publica\\')\" ng-repeat=\"delegado in vm.attributes.delegados\" md-component-id=\"panelConfiguracionDelegacion_{{$index}}\" id=\"panelConfiguracionDelegacion_{{$index}}\"> <md-expansion-panel-collapsed> <div class=\"md-title\" translate>{{delegado.nombre.substring(delegado.nombre.indexOf(\\'_\\')+1)}}</div> <div class=\"md-summary\">Configurar la delegaci&oacute;n</div> <md-expansion-panel-icon></md-expansion-panel-icon> </md-expansion-panel-collapsed> <md-expansion-panel-expanded> <md-expansion-panel-header ng-click=\"$panel.collapse()\"> <div class=\"md-title\" translate>{{delegado.nombre.substring(delegado.nombre.indexOf(\\'_\\')+1)}}</div> <div class=\"md-summary\">Configurar la delegaci&oacute;n</div> <md-expansion-panel-icon></md-expansion-panel-icon> </md-expansion-panel-header> <md-expansion-panel-content> <strong>Estado: </strong><span ng-if=\"delegado.reclamado\">Reclamado</span><span ng-if=\"!delegado.reclamado\">Aún no reclamado</span> <br /> <strong>Costeado por: </strong><span ng-if=\"delegado.delegacionPorCargoDe==\\'delegador\\'\">Mí (delegador)</span><span ng-if=\"delegado.delegacionPorCargoDe==\\'delegado\\'\">Delegado</span> <br /> <strong>Nombre de reclamación: </strong> {{delegado.nombre}}<br /> <md-button class=\"md-raised md-button ng-isolate-scope md-ink-ripple\" ngclipboard=\"\" data-clipboard-action=\"copy\" data-clipboard-text=\"{{delegado.claimingData.secretKey}}\">Copiar clave de reclamación</md-button> <br /> <br /> <form name=\"form.configurarDelegacion_{{$index}}\" class=\"configure-entity-form\" ng-submit=\"vm.configurarDelegacion(delegado.id,$index)\">';\n            salida += opcionesDelegacion;\n            salida +=\n                '<md-button type=\"submit\" ng-disabled=\"form.configurarDelegacion_{{$index}}.$invalid || !form.configurarDelegacion_{{$index}}.$dirty\" class=\"md-raised md-primary\"> Actualizar </md-button> <md-button type=\"submit\" ng-click=\"vm.delegacion[$index].borrar=true\" class=\"md-raised md-primary\"> Borrar </md-button>';\n            salida +=\n                '</form> </md-expansion-panel-content> </md-expansion-panel-expanded> </md-expansion-panel> </md-expansion-panel-group> </div></md-dialog-content>';\n\n            htmlTemplate2 =\n                htmlTemplate2\n                .replace(\n                    '<sustituir-delegacion class=\"ng-scope\"></sustituir-delegacion>',\n                    salida);\n        } else if (attributes[i].key ==\n            \"credito\") {\n            //Si no hay crédito no se pueden crear dispositivos\n            if (parseInt(attributes[i]\n                    .value) > 0) {\n                allowedEntityTypes = [\n                    types\n                    .entityType\n                    .asset,\n                    types.entityType\n                    .device\n                ];\n            } else {\n                allowedEntityTypes = [\n                    types\n                    .entityType\n                    .asset\n                ];\n            }\n\n        }\n\n    }\n\n    openEditEntityDialog();\n}\n\n\nfunction openEditEntityDialog() {\n    $mdDialog.show({\n        controller: ['$scope',\n            '$mdDialog',\n            EditEntityDialogController\n        ],\n        controllerAs: 'vm',\n        template: htmlTemplate2,\n        locals: {\n            entityId: entityId\n        },\n        parent: angular.element(\n            $document[0]\n            .body),\n        targetEvent: $event,\n        multiple: true,\n        clickOutsideToClose: false\n    });\n}\n\n\nfunction crearFuncion($scope, codigo) {\n    return function() {\n        eval(codigo);\n    };\n}\n\nfunction EditEntityDialogController(\n    $scope,\n    $mdDialog) {\n    $scope.form = {};\n    $scope.chip = \"$scope\";\n    var vm = this;\n    vm.entityId = entityId;\n    vm.entityName = entityName;\n    vm.entityType = entityId.entityType;\n    vm.allowedEntityTypes =\n        allowedEntityTypes;\n    vm.allowedRelatedEntityTypes = [];\n    vm.entitySearchDirection = types\n        .entitySearchDirection;\n    vm.tiposDeDispositivos = {};\n    vm.tiposDeActivos = {};\n    vm.activos = {};\n    vm.padre = {};\n    vm.attributes = {};\n    vm.configuracion = {};\n    vm.existeInicializacion = false;\n\n    //vm.configuracion.___fechaHora = new Date();\n\n\n    vm.configuracion.__alarmas = {};\n    for (var j = 0; j <\n        emailsAdicionales\n        .length; j++) {\n        vm.configuracion.__alarmas[\n            emailsAdicionales[\n                j]] = {};\n        vm.configuracion.__alarmas[\n                emailsAdicionales[j]]\n            .emailsAdicionales = [];\n        //console.log(emailsAdicionales[j]);\n    }\n\n    vm.viasNotificacion = {};\n    vm.serverAttributes = {};\n    vm.relations = [];\n    vm.newRelations = [];\n    vm.relationsToDelete = [];\n    vm.borrable = true;\n    vm.HTMLconfig = \"\";\n    vm.subtipo = subtipo;\n    vm.configurable = configurable;\n    vm.delegable = delegable;\n    vm.delegacion = {};\n    vm.estaDelegado = false;\n    vm.attributes.esDelegado = false;\n    vm.existeDelegacionPublica = false;\n    vm.urlDashboard = urlDashboard;\n    vm.urlStatePublic = \"\";\n\n    getEntityInfo();\n\n    //Creo las funciones\n    if (funciones.length > 0) {\n        for (var k = 0; k < funciones\n            .length; k++) {\n            var obj = funciones[k];\n            if (obj.nombre !=\n                'inicializacion') {\n                $scope[obj.nombre] =\n                    crearFuncion(\n                        $scope,\n                        obj\n                        .codigo);\n            } else {\n                //Si existe la funcion inicialización, la ejecuto\n                //eval(obj.codigo);\n\n                $scope.inicializacion =\n                    crearFuncion($scope,\n                        obj\n                        .codigo);\n                vm.existeInicializacion =\n                    true;\n\n            }\n        }\n    }\n\n    vm.addRelation = function() {\n        var relation = {\n            direction: null,\n            relationType: null,\n            relatedEntity: null\n        };\n        vm.newRelations.push(\n            relation);\n        $scope.editEntityForm\n            .$setDirty();\n    };\n    vm.removeRelation = function(\n        index) {\n        if (index > -1) {\n            vm.newRelations.splice(\n                index, 1);\n            $scope.editEntityForm\n                .$setDirty();\n        }\n    };\n    vm.removeOldRelation = function(\n        index,\n        relation) {\n        if (index > -1) {\n            vm.relations.splice(\n                index,\n                1);\n            vm.relationsToDelete\n                .push(\n                    relation);\n            $scope.editEntityForm\n                .$setDirty();\n        }\n    };\n    vm.borrar = function() {\n        openDeleteEntityDialog();\n\n        function openDeleteEntityDialog() {\n            $scope.form\n                .deleteEntityForm\n                .$setPristine();\n            var title = 'Borrar ' +\n                entityName;\n            var content =\n                '¿Seguro que desea borrar la entidad ' +\n                entityName + '?';\n            var confirm = $mdDialog\n                .confirm()\n                .targetEvent($event)\n                .title(title)\n                .htmlContent(\n                    content)\n                .ariaLabel(title)\n                .cancel('Cancelar')\n                .ok('Borrar');\n            $mdDialog.show(confirm)\n                .then(\n                    function() {\n                        deleteEntity\n                            ();\n                    });\n        }\n\n        function deleteEntity() {\n            servicioHTTP({\n                method: 'POST',\n                url: $location\n                    .protocol() +\n                    '://' +\n                    $location\n                    .host() +\n                    ':' +\n                    $location\n                    .port() +\n                    '/api/v1/' +\n                    vm\n                    .tokenControl +\n                    '/telemetry',\n                data: \"{'accion':'borrarEntidad','nombreEntidad':'_\" +\n                    vm\n                    .attributes\n                    .nombreEntidad +\n                    \"','idEntidad':'\" +\n                    vm\n                    .entityId\n                    .id +\n                    \"','tipoEntidad':'\" +\n                    vm\n                    .entityType +\n                    \"'}\"\n            }).\n            success(function(data,\n                status,\n                headers,\n                config) {\n                //Con el sistema de queues es más lento\n                //Habría que obtener de algún modo una confirmación del borrado\n                //o simplemente una pausa\n                setTimeout(\n                    updateAliasData,\n                    2000\n                );\n                console.log(\n                    'worked'\n                );\n                //updateAliasData();\n                $mdDialog\n                    .hide();\n                // ...\n            }).\n            error(function(data,\n                status,\n                headers,\n                config) {\n                console.log(\n                    'notworked'\n                );\n                // ...\n            });\n        }\n    };\n    vm.crear = function() {\n        //console.log( vm.crearEntidad.nombreEntidad);\n        //TODO: Gestionar colisión de nombres\n        servicioHTTP({\n            method: 'POST',\n            url: $location\n                .protocol() +\n                '://' +\n                $location\n                .host() +\n                ':' +\n                $location\n                .port() +\n                '/api/v1/' +\n                vm\n                .tokenControl +\n                '/telemetry',\n            data: \"{'accion':'crearEntidad','nombreEntidad':'_\" +\n                vm\n                .crearEntidad\n                .nombreEntidad +\n                \"','tipoEntidad':'\" +\n                vm\n                .crearEntidad\n                .tipoEntidad +\n                \"','subtipoEntidad':'\" +\n                vm\n                .crearEntidad\n                .subtipoEntidad +\n                \"','padreEntidadId':'\" +\n                vm\n                .entityId\n                .id +\n                \"','padreEntidadNombre':'\" +\n                vm\n                .entityName +\n                \"'}\"\n        }).\n        success(function(data,\n            status,\n            headers,\n            config) {\n            console.log(\n                'worked'\n            );\n            setTimeout(\n                updateAliasData,\n                2000);\n            //updateAliasData();\n            $scope.form\n                .addEntityForm\n                .$setPristine();\n            $mdDialog\n                .hide();\n            // ...\n        }).\n        error(function(data, status,\n            headers,\n            config) {\n            console.log(\n                'notworked'\n            );\n            // ...\n        });\n    };\n\n\n\n\n\n    vm.save = function() {\n        servicioHTTP({\n            method: 'POST',\n            url: $location\n                .protocol() +\n                '://' +\n                $location\n                .host() +\n                ':' +\n                $location\n                .port() +\n                '/api/v1/' +\n                vm\n                .tokenControl +\n                '/telemetry',\n            data: \"{'accion':'editarEntidad','idEntidad':'\" +\n                vm.entityId\n                .id +\n                \"','nombreEntidad':'_\" +\n                vm\n                .attributes\n                .nombreEntidad +\n                \"','subtipoEntidad':'\" +\n                vm\n                .attributes\n                .tipoEntidad +\n                \"','tipoEntidad':'\" +\n                vm\n                .entityType +\n                \"','padreEntidad':'\" +\n                vm\n                .padre +\n                \"','tipoPadreEntidad':'\" +\n                vm\n                .activos[vm\n                    .padre]\n                .tipo +\n                \"'}\"\n        }).\n        success(function(data,\n            status,\n            headers,\n            config) {\n            console.log(\n                'worked'\n            );\n            setTimeout(\n                updateAliasData,\n                2000);\n            //updateAliasData();\n            $scope.form\n                .editEntityForm\n                .$setPristine();\n            $mdDialog\n                .hide();\n            // ...\n        }).\n        error(function(data, status,\n            headers,\n            config) {\n            console.log(\n                'notworked'\n            );\n            // ...\n        });\n\n\n        //saveAttributes();\n        //saveRelations();\n        //$scope.editEntityForm.$setPristine();\n    };\n\n    vm.configurar = function() {\n        //Si hay atributos de alarma tengo que stringifycarlos\n\n        vm.configuracion.__alarmas =\n            JSON\n            .stringify(\n                vm\n                .configuracion\n                .__alarmas\n            );\n        vm.configuracion = JSON\n            .stringify(vm\n                .configuracion);\n        //console.log(vm.configuracion);\n        servicioHTTP({\n            method: 'POST',\n            url: $location\n                .protocol() +\n                '://' +\n                $location\n                .host() +\n                ':' +\n                $location\n                .port() +\n                '/api/v1/' +\n                vm\n                .tokenControl +\n                '/telemetry',\n            data: \"{'accion':'configurarEntidad','idEntidad':'\" +\n                vm.entityId\n                .id +\n                \"','configuracion':\" +\n                vm\n                .configuracion +\n                \"}\"\n        }).\n        success(function(data,\n            status,\n            headers,\n            config) {\n            console.log(\n                'worked'\n            );\n            updateAliasData\n                ();\n            $scope.form\n                .editEntityForm\n                .$setPristine();\n            $mdDialog\n                .hide();\n            // ...\n        }).\n        error(function(data, status,\n            headers,\n            config) {\n            console.log(\n                'notworked'\n            );\n            // ...\n        });\n\n\n        //saveAttributes();\n        //saveRelations();\n        //$scope.editEntityForm.$setPristine();\n    };\n\n    vm.delegar = function() {\n        //console.log(vm.attributes.delegados);\n        servicioHTTP({\n            method: 'POST',\n            url: $location\n                .protocol() +\n                '://' +\n                $location\n                .host() +\n                ':' +\n                $location\n                .port() +\n                '/api/v1/' +\n                vm\n                .tokenControl +\n                '/telemetry',\n            data: \"{'accion':'crearDelegado','nombreDispositivo':'\" +\n                vm\n                .nombreDelegado +\n                \"','tokenDelegado':'\" +\n                vm\n                .tokenDelegado +\n                \"','delegacionPorCargoDe':'\" +\n                vm\n                .delegacionPorCargoDe +\n                \"','idDispositivoPadre':'\" +\n                vm.entityId\n                .id +\n                \"','nombreDispositivoPadre':'\" +\n                vm\n                .entityName +\n                \"','subtipoDispositivo':'\" +\n                vm\n                .subtipo +\n                \"'}\"\n        }).\n        success(function(data,\n            status,\n            headers,\n            config) {\n            console.log(\n                'worked'\n            );\n            updateAliasData\n                ();\n            $scope.form\n                .editEntityForm\n                .$setPristine();\n            $mdDialog\n                .hide();\n            // ...\n        }).\n        error(function(data, status,\n            headers,\n            config) {\n            console.log(\n                'notworked'\n            );\n            // ...\n        });\n\n\n        //saveAttributes();\n        //saveRelations();\n        //$scope.editEntityForm.$setPristine();\n    };\n    vm.configurarDelegacion = function(\n        idDelegacion,\n        indice) {\n\n        servicioHTTP({\n            method: 'POST',\n            url: $location\n                .protocol() +\n                '://' +\n                $location\n                .host() +\n                ':' +\n                $location\n                .port() +\n                '/api/v1/' +\n                vm\n                .tokenControl +\n                '/telemetry',\n            data: \"{'accion':'configurarDelegacion','nombreDispositivo':'\" +\n                vm\n                .entityName +\n                \"','idDispositivo':'\" +\n                vm.entityId\n                .id +\n                \"','idDelegacion':'\" +\n                idDelegacion +\n                \"','subtipoDispositivo':'\" +\n                vm\n                .subtipo +\n                \"','delegacion':'\" +\n                JSON\n                .stringify(\n                    vm\n                    .delegacion[\n                        indice\n                    ]\n                ) + \"'}\"\n        }).\n        success(function(data,\n            status,\n            headers,\n            config) {\n            console.log(\n                'worked'\n            );\n            updateAliasData\n                ();\n            $scope.form\n                .editEntityForm\n                .$setPristine();\n            $mdDialog\n                .hide();\n            // ...\n        }).\n        error(function(data, status,\n            headers,\n            config) {\n            console.log(\n                'notworked'\n            );\n            // ...\n        });\n    };\n    vm.cancel = function() {\n        $mdDialog.hide();\n    };\n\n    function getEntityAttributes(\n        attributes) {\n//console.log(attributes);\n//console.log(vm.configuracion.__alarmas);\n        //El nombre de todos los atributos de configuración va a comenzar con __\n        for (var i = 0; i < attributes\n            .length; i++) {\n            if (attributes[i].key\n                .substr(0,\n                    2) ==\n                \"__\") {\n                if (attributes[i].key ==\n                    \"__alarma_\" +\n                    vm\n                    .subtipo) {\n\n                    //var alarmas = JSON.parse(attributes[i].value);\n                    var alarmas =\n                        attributes[\n                            i]\n                        .value;\n\n                    for (var clave in\n                            alarmas) {\n\n                        vm.configuracion\n                            .__alarmas[\n                                clave] =\n                            alarmas[\n                                clave];\n\n                        if (!alarmas[\n                                clave]\n                            .hasOwnProperty(\n                                'habilitacionTemporal'\n                            )\n                        ) {\n                            vm.configuracion\n                                .__alarmas[\n                                    clave\n                                ]\n                                .habilitacionTemporal =\n                                false;\n                        }\n\n                        if (!alarmas[\n                                clave]\n                            .hasOwnProperty(\n                                'emailsAdicionales'\n                            )\n                        ) {\n                            vm.configuracion\n                                .__alarmas[\n                                    clave\n                                ]\n                                .emailsAdicionales = [];\n                        }\n                    }\n                    /*\n                                    } else if (attributes[i].key ==\n                                        \"___fechaHora\") {\n                                        vm.configuracion.___fechaHora = new Date(attributes[i].value);\n                    */\n\n                } else if (attributes[i]\n                    .key ==\n                    \"___ultimoDownlink\"\n                ) {\n                    //No hago nada. No me gusta que esté aquí. Debería gestionarse en las reglas.\n                    //Ya se gestiona en las reglas, pero lo dejo porque podrían quedar dispositivos que aún lo tengan.\n\n                } else {\n                    vm.configuracion[\n                            attributes[\n                                i]\n                            .key] =\n                        attributes[i]\n                        .value;\n                }\n            } else if (attributes[i]\n                .key ==\n                \"nombreEntidad\") {\n                //Hago esto para quitar el guión bajo y evitar que se puedan perder leading zeros\n                vm.attributes[\n                        attributes[i]\n                        .key] =\n                    attributes[i].value\n                    .substr(1);\n            } else if (attributes[i]\n                .key ==\n                \"delegados\") {\n                vm.attributes[\n                        attributes[i]\n                        .key] =\n                    attributes[i].value;\n\n                if (typeof attributes[i]\n                    .value ==\n                    'object' &&\n                    attributes[\n                        i].value\n                    .length >\n                    0) {\n                    vm.borrable = false;\n                    vm.estaDelegado =\n                        true;\n\n\n                }\n\n            } else {\n                vm.attributes[\n                        attributes[i]\n                        .key] =\n                    attributes[i].value;\n            }\n        }\n        //Ejecuto la función de inicialización si existe\n        if (vm.existeInicializacion ==\n            true) {\n\n            $scope.inicializacion();\n        }\n\n        if (vm.attributes.hasOwnProperty('delegados') &&\n            vm.attributes.delegados.find(o => o.nombre\n                .startsWith(\n                    \"D\" + vm.entityName.split('_').shift() +\n                    \"__\" + vm.entityId.id + \"_publica\"))) {\n\n            vm.existeDelegacionPublica = true;\n            var delegacionPublica = vm.attributes.delegados\n                .find(o => o.nombre.startsWith(\"D\" + vm\n                    .entityName.split('_').shift() +\n                    \"__\" + vm.entityId.id + \"_publica\"));\n\n            vm.urlStatePublic = encodeBase64(\n                '[{\"params\":{\"entityId\":{\"entityType\":\"DEVICE\",\"id\":\"' +\n                delegacionPublica.id +\n                '\"},\"entityName\":\"' + delegacionPublica\n                .nombre + '\"}}]');\n        }\n        \n        //console.log(vm.configuracion.__alarmas);\n        //console.log(vm.attributes);\n        //console.log(vm.configuracion);\n        //console.log(vm);\n        vm.serverAttributes = angular\n            .copy(\n                vm\n                .attributes);\n    }\n\n    function getTiposDeActivosYDispositivos(\n        attributes) {\n        for (var i = 0; i < attributes\n            .length; i++) {\n            if (attributes[i].key ==\n                \"tiposDeDispositivos\") {\n                vm.tiposDeDispositivos =\n                    attributes[\n                        i]\n                    .value\n                    .split(\",\");\n            } else if (attributes[i]\n                .key ==\n                \"tiposDeActivos\") {\n                vm.tiposDeActivos =\n                    attributes[i]\n                    .value\n                    .split(\",\");\n            } else if (attributes[i]\n                .key ==\n                \"email\") {\n                if (attributes[i]\n                    .value !==\n                    \"\") {\n                    vm.viasNotificacion\n                        .email =\n                        true;\n                } else {\n                    vm.viasNotificacion\n                        .email =\n                        false;\n                }\n            } else if (attributes[i]\n                .key ==\n                \"token_telegram\") {\n                if (attributes[i]\n                    .value !==\n                    \"\") {\n                    vm.viasNotificacion\n                        .telegram =\n                        true;\n                } else {\n                    vm.viasNotificacion\n                        .telegram =\n                        false;\n                }\n\n            } else if (attributes[i]\n                .key ==\n                \"token_webhook_ifttt\") {\n                if (attributes[i]\n                    .value !==\n                    \"\") {\n                    vm.viasNotificacion\n                        .ifttt =\n                        true;\n                } else {\n                    vm.viasNotificacion\n                        .ifttt =\n                        false;\n                }\n            } else if (attributes[i]\n                .key ==\n                \"id_sala_matrix\") {\n                if (attributes[i]\n                    .value !==\n                    \"\") {\n                    vm.viasNotificacion\n                        .matrix =\n                        true;\n                } else {\n                    vm.viasNotificacion\n                        .matrix =\n                        false;\n                }\n\n            }\n        }\n\n    }\n\n\n    function getActivos(activos) {\n        //Los uso para establecer los padres\n        //Aquí habrá que generalizar para usar los atributos nombre y tipo, en lugar de los fields?\n        for (var i = 0; i < activos\n            .length; i++) {\n            //Si es un activo no debe incluirse a sí mismo\n            if (vm.entityType ==\n                \"DEVICE\" ||\n                vm\n                .entityId\n                .id !=\n                activos[i].id.id) {\n                getAtributosActivo(\n                    activos[\n                        i].id.id,\n                    activos[i].name,\n                    activos[i]\n                    .type\n                );\n\n            } else {\n                //console.log(\"b_\" + vm.entityId.id + \"__\" +activos[i].id.id);\n            }\n        }\n        //console.log(vm.activos);\n    }\n\n    function getAtributosActivo(id,\n        nombreActivo,\n        tipoActivo) {\n        attributeService\n            .getEntityAttributesValues(\n                'ASSET',\n                id, 'SERVER_SCOPE')\n            .then(\n                function success(data) {\n                    var parametros = {};\n                    for (var i = 0; i <\n                        data\n                        .length; i++) {\n                        //console.log(data[i].key,data[i].value);\n                        if (data[i]\n                            .key ==\n                            \"nombreEntidad\"\n                        ) {\n                            parametros[\n                                    'nombreEntidad'\n                                ] =\n                                data[i]\n                                .value\n                                .substr(\n                                    1);\n                        } else {\n                            parametros[\n                                    data[\n                                        i\n                                    ]\n                                    .key\n                                ] =\n                                data[\n                                    i]\n                                .value;\n                        }\n                    }\n                    vm.activos[\n                        nombreActivo\n                    ] = {\n                        'tipo': tipoActivo,\n                        'atributos': parametros\n                    };\n                    //console.log(vm.activos[nombreActivo]);\n\n                });\n    }\n\n\n    function getEntityRelations(\n        relations) {\n\n        var relationsFrom = relations[\n            0];\n        var relationsTo = relations[1];\n        //Si tiene hijos no se puede borrar\n\n        for (var i = 0; i <\n            relationsFrom\n            .length; i++) {\n            vm.borrable = false;\n            var relation = {\n                direction: types\n                    .entitySearchDirection\n                    .from,\n                relationType: relationsFrom[\n                        i]\n                    .type,\n                relatedEntity: relationsFrom[\n                        i]\n                    .to\n            };\n            vm.relations.push(relation);\n        }\n\n        for (var i = 0; i < relationsTo\n            .length; i++) {\n\n            var relation = {\n                direction: types\n                    .entitySearchDirection\n                    .to,\n                relationType: relationsTo[\n                        i]\n                    .type,\n                relatedEntity: relationsTo[\n                        i]\n                    .from\n            };\n            if (relation.relationType ==\n                \"Contains\" &&\n                relation.relatedEntity\n                .entityType ==\n                \"ASSET\"\n            ) {\n                establecerNombrePadre(\n                    relation\n                    .relatedEntity\n                    .id);\n                //Necesito el nombre del padre\n            }\n            vm.relations.push(relation);\n        }\n\n    }\n\n    function establecerNombrePadre(id) {\n        assetService.getAsset(id).then(\n            function(data) {\n                vm.padre = data\n                    .name;\n                //console.log(vm.padre);\n            }\n        );\n    }\n\n    function getEntityInfo() {\n        entityService.getEntity(entityId\n            .entityType,\n            entityId.id).then(\n            function(entity) {\n                vm.entity = entity;\n                vm.type = vm.entity\n                    .type;\n            });\n\n        attributeService\n            .getEntityAttributesValues(\n                entityId.entityType,\n                entityId.id,\n                'SERVER_SCOPE').then(\n                function(data) {\n                    if (data.length) {\n                        getEntityAttributes\n                            (\n                                data);\n                    }\n                });\n        //Obtngo los tipos de activos y dispositivos \n        //que tiene permitidos el customer en sus atributos\n        //y también las vías de notificación (ifttt, telegram...)\n        attributeService\n            .getEntityAttributesValues(\n                'CUSTOMER', userService\n                .getCurrentUser()\n                .customerId,\n                'SERVER_SCOPE').then(\n                function(data) {\n                    if (data.length) {\n                        getTiposDeActivosYDispositivos\n                            (\n                                data);\n                    }\n                });\n        //Obtengo los activos del customer para poder\n        //mostrarlos como potenciales padres\n        assetService.getCustomerAssets(\n            userService\n            .getCurrentUser()\n            .customerId, {\n                \"limit\": 100\n            }).then(\n            function(data) {\n                if (data.data\n                    .length) {\n                    getActivos(data\n                        .data);\n\n                }\n            });\n\n        //Obtengo el token del dispositivo SYSTEM\n        deviceService\n            .getCustomerDevices(\n                userService\n                .getCurrentUser()\n                .customerId, {\n                    \"limit\": 100\n                }, false, {}, 'SYSTEM')\n            .then(\n                function(data) {\n                    if (data.data\n                        .length ==\n                        1) {\n                        deviceService\n                            .getDeviceCredentials(\n                                data\n                                .data[0]\n                                .id.id,\n                                true, {}\n                            ).then(\n                                function(\n                                    response\n                                ) {\n                                    vm.tokenControl =\n                                        response\n                                        .credentialsId;\n\n                                });\n                    }\n                });\n\n\n        $q.all([entityRelationService\n            .findInfoByFrom(\n                entityId.id,\n                entityId\n                .entityType\n            ),\n            entityRelationService\n            .findInfoByTo(\n                entityId\n                .id,\n                entityId\n                .entityType)\n        ]).then(\n            function(relations) {\n                //CUIDADO: Sólo obtiene las relaciones respecto a elementos (customer, asset y diveces) que son accesibles por el propio customer\n                //Por ejemplo, no obtiene las relaciones a dispositivos delegados porque no están asignados al customer\n                getEntityRelations(\n                    relations);\n            });\n\n    }\n\n    function saveAttributes() {\n        var attributesArray = [];\n        for (var key in vm.attributes) {\n            if (vm.attributes[key] !==\n                vm\n                .serverAttributes[key]\n            ) {\n                attributesArray.push({\n                    key: key,\n                    value: vm\n                        .attributes[\n                            key]\n                });\n            }\n        }\n        if (attributesArray.length >\n            0) {\n            attributeService\n                .saveEntityAttributes(\n                    entityId.entityType,\n                    entityId\n                    .id,\n                    \"SERVER_SCOPE\",\n                    attributesArray);\n        }\n    }\n\n    function saveRelations() {\n        var tasks = [];\n        for (var i = 0; i < vm\n            .newRelations\n            .length; i++) {\n            var relation = {\n                type: vm\n                    .newRelations[i]\n                    .relationType\n            };\n            if (vm.newRelations[i]\n                .direction ==\n                types\n                .entitySearchDirection\n                .from\n            ) {\n                relation.to = vm\n                    .newRelations[i]\n                    .relatedEntity;\n                relation.from =\n                    entityId;\n            } else {\n                relation.to = entityId;\n                relation.from = vm\n                    .newRelations[i]\n                    .relatedEntity;\n            }\n            tasks.push(\n                entityRelationService\n                .saveRelation(\n                    relation));\n        }\n        for (var i = 0; i < vm\n            .relationsToDelete\n            .length; i++) {\n            var relation = {\n                type: vm\n                    .relationsToDelete[\n                        i]\n                    .relationType\n            };\n            if (vm.relationsToDelete[i]\n                .direction ==\n                types\n                .entitySearchDirection\n                .from) {\n                relation.to = vm\n                    .relationsToDelete[\n                        i]\n                    .relatedEntity;\n                relation.from =\n                    entityId;\n            } else {\n                relation.to = entityId;\n                relation.from = vm\n                    .relationsToDelete[\n                        i]\n                    .relatedEntity;\n            }\n            tasks.push(\n                entityRelationService\n                .deleteRelation(\n                    relation\n                    .from\n                    .id,\n                    relation.from\n                    .entityType,\n                    relation.type,\n                    relation.to\n                    .id,\n                    relation.to\n                    .entityType));\n        }\n        $q.all(tasks).then(function() {\n            vm.relations = vm\n                .relations\n                .concat(\n                    vm\n                    .newRelations\n                );\n            vm\n                .newRelations = [];\n            vm\n                .relationsToDelete = [];\n            updateAliasData();\n        });\n    }\n\n    function updateAliasData() {\n        var aliasIds = [];\n        for (var id in widgetContext\n                .aliasController\n                .resolvedAliases) {\n            aliasIds.push(id);\n        }\n        var tasks = [];\n        aliasIds.forEach(function(\n            aliasId) {\n            widgetContext\n                .aliasController\n                .setAliasUnresolved(\n                    aliasId);\n            tasks.push(\n                widgetContext\n                .aliasController\n                .getAliasInfo(\n                    aliasId)\n            );\n        });\n        $q.all(tasks).then(function() {\n            $rootScope\n                .$broadcast(\n                    'entityAliasesChanged',\n                    aliasIds);\n        });\n    }\n\n}"
              }
            ]
          },
          "showTitleIcon": false,
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "displayTimewindow": true
        },
        "id": "fba8b82f-4b63-d360-68e1-9481f57706b1"
      },
      "f1a629d9-faa9-ae03-8c9e-91e0037b17bc": {
        "isSystemType": true,
        "bundleAlias": "iotopentech",
        "typeAlias": "perfil2",
        "type": "static",
        "title": "New widget",
        "sizeX": 7,
        "sizeY": 17,
        "config": {
          "datasources": [],
          "timewindow": {
            "realtime": {
              "timewindowMs": 60000
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "showResultMessage": true,
            "widgetTitle": "PERFUL DE"
          },
          "title": "PERFIL DE USUARIO",
          "dropShadow": true,
          "showTitleIcon": false,
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "enableFullscreen": true,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "showLegend": false,
          "actions": {}
        },
        "id": "f1a629d9-faa9-ae03-8c9e-91e0037b17bc"
      },
      "58b27f5a-e29a-7c88-111f-586d8b32a086": {
        "isSystemType": true,
        "bundleAlias": "iotopentech",
        "typeAlias": "device_claiming_widget",
        "type": "static",
        "title": "New widget",
        "sizeX": 9,
        "sizeY": 6,
        "config": {
          "datasources": [],
          "timewindow": {
            "realtime": {
              "timewindowMs": 60000
            }
          },
          "showTitle": true,
          "backgroundColor": "rgb(255, 255, 255)",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "deviceSecret": true,
            "showLabel": true
          },
          "title": "RECLAMAR DISPOSITIVO",
          "dropShadow": true,
          "showTitleIcon": false,
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "enableFullscreen": false,
          "enableDataExport": true,
          "widgetStyle": {},
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "useDashboardTimewindow": true,
          "displayTimewindow": true,
          "showLegend": false,
          "actions": {}
        },
        "id": "58b27f5a-e29a-7c88-111f-586d8b32a086"
      },
      "74f06f8b-d82d-d5c4-b438-da0472ecf7e8": {
        "isSystemType": true,
        "bundleAlias": "cards",
        "typeAlias": "simple_card",
        "type": "latest",
        "title": "New widget",
        "sizeX": 8,
        "sizeY": 3,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "dataKeys": [
                {
                  "name": "dispositivosPropios",
                  "type": "attribute",
                  "label": "Dispositivos propios",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.684586138282518
                }
              ],
              "entityAliasId": "d5716c46-7e3f-d8a7-163b-c9a265a4ea0f"
            }
          ],
          "timewindow": {
            "realtime": {
              "timewindowMs": 60000
            }
          },
          "showTitle": false,
          "backgroundColor": "#ff5722",
          "color": "rgba(255, 255, 255, 0.87)",
          "padding": "16px",
          "settings": {
            "labelPosition": "top"
          },
          "title": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "units": "",
          "decimals": 0,
          "useDashboardTimewindow": true,
          "showLegend": false,
          "widgetStyle": {},
          "actions": {
            "headerButton": [
              {
                "id": "015add2c-d27a-b5ef-e7a7-034e67e121cc",
                "name": "Contabilidad",
                "icon": "multiline_chart",
                "type": "openDashboardState",
                "targetDashboardStateId": "contabilidad",
                "setEntityId": true
              }
            ]
          },
          "showTitleIcon": false,
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "displayTimewindow": true
        },
        "id": "74f06f8b-d82d-d5c4-b438-da0472ecf7e8"
      },
      "97cdc902-7547-2fd8-caab-ecca41cf46a8": {
        "isSystemType": true,
        "bundleAlias": "cards",
        "typeAlias": "simple_card",
        "type": "latest",
        "title": "New widget",
        "sizeX": 8,
        "sizeY": 3,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "dataKeys": [
                {
                  "name": "credito",
                  "type": "attribute",
                  "label": "Crédito",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.6455316370969023
                }
              ],
              "entityAliasId": "d5716c46-7e3f-d8a7-163b-c9a265a4ea0f"
            }
          ],
          "timewindow": {
            "realtime": {
              "timewindowMs": 60000
            }
          },
          "showTitle": false,
          "backgroundColor": "#ff5722",
          "color": "rgba(255, 255, 255, 0.87)",
          "padding": "16px",
          "settings": {
            "labelPosition": "top"
          },
          "title": "",
          "dropShadow": true,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "units": "",
          "decimals": 0,
          "useDashboardTimewindow": true,
          "showLegend": false,
          "widgetStyle": {},
          "actions": {
            "headerButton": [
              {
                "id": "4f03f567-f6cd-0045-6053-ea4b60141306",
                "name": "Contabilidad",
                "icon": "multiline_chart",
                "type": "openDashboardState",
                "targetDashboardStateId": "contabilidad",
                "setEntityId": true
              }
            ]
          },
          "showTitleIcon": false,
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "displayTimewindow": true
        },
        "id": "97cdc902-7547-2fd8-caab-ecca41cf46a8"
      },
      "48c9f0e5-c2eb-3968-b0ac-d139e2137268": {
        "isSystemType": true,
        "bundleAlias": "charts",
        "typeAlias": "timeseries_bars_flot",
        "type": "timeseries",
        "title": "New widget",
        "sizeX": 24,
        "sizeY": 9,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "dataKeys": [
                {
                  "name": "credito",
                  "type": "timeseries",
                  "label": "Crédito",
                  "color": "#66bb6a",
                  "settings": {
                    "excludeFromStacking": false,
                    "hideDataByDefault": false,
                    "disableDataHiding": false,
                    "removeFromLegend": false,
                    "showLines": false,
                    "fillLines": false,
                    "showPoints": false,
                    "showPointShape": "circle",
                    "pointShapeFormatter": "var size = radius * Math.sqrt(Math.PI) / 2;\nctx.moveTo(x - size, y - size);\nctx.lineTo(x + size, y + size);\nctx.moveTo(x - size, y + size);\nctx.lineTo(x + size, y - size);",
                    "showPointsLineWidth": 5,
                    "showPointsRadius": 3,
                    "showSeparateAxis": false,
                    "axisPosition": "left",
                    "thresholds": [
                      {
                        "thresholdValueSource": "predefinedValue"
                      }
                    ],
                    "comparisonSettings": {
                      "showValuesForComparison": true
                    }
                  },
                  "_hash": 0.6710845221918174
                },
                {
                  "name": "dispositivosPropios",
                  "type": "timeseries",
                  "label": "Nº Dispositivos propios",
                  "color": "#f44336",
                  "settings": {
                    "excludeFromStacking": false,
                    "hideDataByDefault": false,
                    "disableDataHiding": false,
                    "removeFromLegend": false,
                    "showLines": false,
                    "fillLines": false,
                    "showPoints": false,
                    "showPointShape": "circle",
                    "pointShapeFormatter": "var size = radius * Math.sqrt(Math.PI) / 2;\nctx.moveTo(x - size, y - size);\nctx.lineTo(x + size, y + size);\nctx.moveTo(x - size, y + size);\nctx.lineTo(x + size, y - size);",
                    "showPointsLineWidth": 5,
                    "showPointsRadius": 3,
                    "showSeparateAxis": false,
                    "axisPosition": "left",
                    "thresholds": [
                      {
                        "thresholdValueSource": "predefinedValue"
                      }
                    ],
                    "comparisonSettings": {
                      "showValuesForComparison": true
                    }
                  },
                  "_hash": 0.9489344122618633
                },
                {
                  "name": "dispositivosAsumidos",
                  "type": "timeseries",
                  "label": "Nº Dispositivos asumidos",
                  "color": "#fbf300",
                  "settings": {
                    "excludeFromStacking": false,
                    "hideDataByDefault": false,
                    "disableDataHiding": false,
                    "removeFromLegend": false,
                    "showLines": false,
                    "fillLines": false,
                    "showPoints": false,
                    "showPointShape": "circle",
                    "pointShapeFormatter": "var size = radius * Math.sqrt(Math.PI) / 2;\nctx.moveTo(x - size, y - size);\nctx.lineTo(x + size, y + size);\nctx.moveTo(x - size, y + size);\nctx.lineTo(x + size, y - size);",
                    "showPointsLineWidth": 5,
                    "showPointsRadius": 3,
                    "showSeparateAxis": false,
                    "axisPosition": "left",
                    "thresholds": [
                      {
                        "thresholdValueSource": "predefinedValue"
                      }
                    ],
                    "comparisonSettings": {
                      "showValuesForComparison": true
                    }
                  },
                  "_hash": 0.5323685142016874
                }
              ],
              "entityAliasId": "d5716c46-7e3f-d8a7-163b-c9a265a4ea0f"
            }
          ],
          "timewindow": {
            "realtime": {
              "interval": 86400000,
              "timewindowMs": 2592000000
            },
            "aggregation": {
              "type": "NONE",
              "limit": 200
            },
            "hideInterval": false,
            "hideAggregation": false,
            "hideAggInterval": true
          },
          "showTitle": true,
          "backgroundColor": "#fff",
          "color": "rgba(0, 0, 0, 0.87)",
          "padding": "8px",
          "settings": {
            "shadowSize": 4,
            "fontColor": "#545454",
            "fontSize": 10,
            "xaxis": {
              "showLabels": true,
              "color": "#545454"
            },
            "yaxis": {
              "showLabels": true,
              "color": "#545454"
            },
            "grid": {
              "color": "#545454",
              "tickColor": "#DDDDDD",
              "verticalLines": true,
              "horizontalLines": true,
              "outlineWidth": 1
            },
            "stack": false,
            "tooltipIndividual": true,
            "defaultBarWidth": 600,
            "barAlignment": "left",
            "timeForComparison": "months",
            "xaxisSecond": {
              "axisPosition": "top",
              "showLabels": true
            },
            "tooltipCumulative": true
          },
          "title": "New Timeseries Bars - Flot",
          "dropShadow": true,
          "enableFullscreen": true,
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "mobileHeight": null,
          "widgetStyle": {},
          "useDashboardTimewindow": true,
          "showLegend": true,
          "actions": {},
          "showTitleIcon": false,
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "displayTimewindow": false
        },
        "id": "48c9f0e5-c2eb-3968-b0ac-d139e2137268"
      },
      "2d59a12b-2f43-b323-0a99-322890992dbb": {
        "isSystemType": true,
        "bundleAlias": "cards",
        "typeAlias": "simple_card",
        "type": "latest",
        "title": "New widget",
        "sizeX": 8,
        "sizeY": 3,
        "config": {
          "datasources": [
            {
              "type": "entity",
              "dataKeys": [
                {
                  "name": "dispositivosAsumidos",
                  "type": "attribute",
                  "label": "Dispositivos asumidos",
                  "color": "#2196f3",
                  "settings": {},
                  "_hash": 0.14500773985489313
                }
              ],
              "entityAliasId": "d5716c46-7e3f-d8a7-163b-c9a265a4ea0f"
            }
          ],
          "timewindow": {
            "realtime": {
              "timewindowMs": 60000
            }
          },
          "showTitle": false,
          "backgroundColor": "#ff5722",
          "color": "rgba(255, 255, 255, 0.87)",
          "padding": "16px",
          "settings": {
            "labelPosition": "top"
          },
          "title": "Dispositivos asumidos",
          "dropShadow": true,
          "enableFullscreen": false,
          "titleStyle": {
            "fontSize": "16px",
            "fontWeight": 400
          },
          "units": "",
          "decimals": 0,
          "useDashboardTimewindow": true,
          "showLegend": false,
          "widgetStyle": {},
          "actions": {
            "headerButton": [
              {
                "id": "f21e05bf-f2e0-941c-f9e5-3b156f6ee8ca",
                "name": "Contabilidad",
                "icon": "multiline_chart",
                "type": "openDashboardState",
                "targetDashboardStateId": "contabilidad",
                "setEntityId": true
              }
            ]
          },
          "showTitleIcon": false,
          "titleIcon": null,
          "iconColor": "rgba(0, 0, 0, 0.87)",
          "iconSize": "24px",
          "titleTooltip": "",
          "displayTimewindow": true
        },
        "id": "2d59a12b-2f43-b323-0a99-322890992dbb"
      }
    },
    "states": {
      "default": {
        "name": "Configuración",
        "root": true,
        "layouts": {
          "main": {
            "widgets": {
              "fba8b82f-4b63-d360-68e1-9481f57706b1": {
                "sizeX": 9,
                "sizeY": 11,
                "row": 0,
                "col": 7
              },
              "f1a629d9-faa9-ae03-8c9e-91e0037b17bc": {
                "sizeX": 7,
                "sizeY": 17,
                "row": 0,
                "col": 0
              },
              "58b27f5a-e29a-7c88-111f-586d8b32a086": {
                "sizeX": 9,
                "sizeY": 6,
                "row": 11,
                "col": 7
              },
              "74f06f8b-d82d-d5c4-b438-da0472ecf7e8": {
                "sizeX": 8,
                "sizeY": 3,
                "row": 3,
                "col": 16
              },
              "97cdc902-7547-2fd8-caab-ecca41cf46a8": {
                "sizeX": 8,
                "sizeY": 3,
                "row": 0,
                "col": 16
              },
              "2d59a12b-2f43-b323-0a99-322890992dbb": {
                "sizeX": 8,
                "sizeY": 3,
                "row": 6,
                "col": 16
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "color": "rgba(0,0,0,0.870588)",
              "columns": 24,
              "margins": [
                10,
                10
              ],
              "backgroundSizeMode": "100%"
            }
          }
        }
      },
      "contabilidad": {
        "name": "Contabilidad",
        "root": false,
        "layouts": {
          "main": {
            "widgets": {
              "48c9f0e5-c2eb-3968-b0ac-d139e2137268": {
                "sizeX": 24,
                "sizeY": 9,
                "mobileHeight": null,
                "row": 0,
                "col": 0
              }
            },
            "gridSettings": {
              "backgroundColor": "#eeeeee",
              "color": "rgba(0,0,0,0.870588)",
              "columns": 24,
              "margins": [
                10,
                10
              ],
              "backgroundSizeMode": "100%"
            }
          }
        }
      }
    },
    "entityAliases": {
      "bc41b835-4a1d-49fc-de3b-142ec2484fd4": {
        "id": "bc41b835-4a1d-49fc-de3b-142ec2484fd4",
        "alias": "ActivoROOT",
        "filter": {
          "type": "assetType",
          "resolveMultiple": false,
          "assetType": "ROOT",
          "assetNameFilter": ""
        }
      },
      "d5716c46-7e3f-d8a7-163b-c9a265a4ea0f": {
        "id": "d5716c46-7e3f-d8a7-163b-c9a265a4ea0f",
        "alias": "customer",
        "filter": {
          "type": "singleEntity",
          "resolveMultiple": false,
          "singleEntity": {
            "entityType": "CURRENT_CUSTOMER",
            "id": "5334c2d0-88bb-11ea-823d-a96a9e8c2286"
          }
        }
      }
    },
    "timewindow": {
      "history": {
        "interval": 86400000,
        "timewindowMs": 2592000000
      },
      "aggregation": {
        "type": "MAX",
        "limit": 25000
      },
      "hideInterval": false,
      "hideAggregation": false,
      "hideAggInterval": false
    },
    "settings": {
      "stateControllerId": "entity",
      "showTitle": false,
      "showDashboardsSelect": true,
      "showEntitiesSelect": true,
      "showDashboardTimewindow": true,
      "showDashboardExport": true,
      "toolbarAlwaysOpen": true
    }
  },
  "name": "Configuración"
}