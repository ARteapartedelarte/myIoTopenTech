{
  "ruleChain": {
    "additionalInfo": null,
    "name": "Root Rule Chain",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null
  },
  "metadata": {
    "firstNodeIndex": 11,
    "nodes": [
      {
        "additionalInfo": {
          "layoutX": 477,
          "layoutY": 617
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "alarma actividad",
        "debugMode": true,
        "configuration": {
          "jsScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 717,
          "layoutY": 237
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "downlink url",
        "debugMode": true,
        "configuration": {
          "jsScript": "if (msg.hasOwnProperty('downlink_url')) {\r\n    return {\r\n        msg: {'downlink_url': msg.downlink_url},\r\n        metadata: metadata,\r\n        msgType: 'POST_ATTRIBUTES_REQUEST'\r\n    };\r\n}"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 717,
          "layoutY": 317
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "guardar downlink url",
        "debugMode": true,
        "configuration": {
          "scope": "SERVER_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1453,
          "layoutY": 317
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "Customer",
        "debugMode": true,
        "configuration": {
          "originatorSource": "CUSTOMER",
          "relationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": []
              }
            ],
            "fetchLastLevelOnly": false
          }
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1725,
          "layoutY": 387
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "guardar atributos",
        "debugMode": true,
        "configuration": {
          "scope": "SERVER_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1729,
          "layoutY": 310
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "preparar atributos",
        "debugMode": true,
        "configuration": {
          "jsScript": "msgType = 'POST_ATTRIBUTES_REQUEST';\n//Valido los atributos que admito modificar\nvar mensaje={};\nif(msg.hasOwnProperty('email')){\n    mensaje.email=msg.email;\n}\nif(msg.hasOwnProperty('token_telegram')){\n    mensaje.token_telegram=msg.token_telegram;\n}\nif(msg.hasOwnProperty('chatid_telegram')){\n    mensaje.chatid_telegram=msg.chatid_telegram;\n}\nif(msg.hasOwnProperty('token_webhook_ifttt')){\n    mensaje.token_webhook_ifttt=msg.token_webhook_ifttt;\n}\n\t\nreturn {msg: mensaje, metadata: metadata, msgType: msgType};\n"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1131,
          "layoutY": 67
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsSwitchNode",
        "name": "acciones",
        "debugMode": true,
        "configuration": {
          "jsScript": "if (msg.hasOwnProperty('accion')) {\n    if (msg.accion == 'editarPerfil') {\n        return ['editarPerfil'];\n    } else if (msg\n        .accion == 'editarEntidad') {\n        if (msg.hasOwnProperty('idEntidad') && msg\n            .hasOwnProperty('nombreEntidad') && msg\n            .hasOwnProperty('tipoEntidad') && msg\n            .hasOwnProperty('subtipoEntidad') && msg\n            .hasOwnProperty('padreEntidad') && msg\n            .hasOwnProperty('tipoPadreEntidad')) {\n            return ['editarEntidad'];\n        }\n    } else if (msg\n        .accion == 'configurarEntidad') {\n        if (msg.hasOwnProperty('idEntidad')  && msg\n            .hasOwnProperty('alarmas')) {\n            return ['configurarEntidad'];\n        }\n    }else if (msg.accion == 'crearEntidad') {\n        if (msg.hasOwnProperty('nombreEntidad') && msg\n            .hasOwnProperty('tipoEntidad') && msg\n            .hasOwnProperty('subtipoEntidad') && msg\n            .hasOwnProperty('padreEntidadId') && msg\n            .hasOwnProperty('padreEntidadNombre')) {\n            return ['crearEntidad'];\n        }\n    } else if (msg.accion == 'borrarEntidad') {\n        if (msg.hasOwnProperty('nombreEntidad') && msg\n            .hasOwnProperty('tipoEntidad')) {\n            return ['borrarEntidad'];\n        }\n    }\n}"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 712,
          "layoutY": 156
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "TTN2JSON",
        "debugMode": true,
        "configuration": {
          "jsScript": "if (msg.hasOwnProperty('payload_fields')) {\r\n    var obj = JSON.parse(msg.payload_fields);\r\n    obj.metadata = msg.metadata;\r\n    obj.downlink_url=msg.downlink_url;\r\n    return {\r\n        msg: obj,\r\n        metadata: metadata,\r\n        msgType: msgType\r\n    };\r\n} else {\r\n    return {\r\n        msg: msg,\r\n        metadata: metadata,\r\n        msgType: msgType\r\n    };\r\n}"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 481,
          "layoutY": 391
        },
        "type": "org.thingsboard.rule.engine.rpc.TbSendRPCRequestNode",
        "name": "RPC Call Request",
        "debugMode": false,
        "configuration": {
          "timeoutInSeconds": 60
        }
      },
      {
        "additionalInfo": {
          "layoutX": 482,
          "layoutY": 321
        },
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log Other",
        "debugMode": true,
        "configuration": {
          "jsScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 496,
          "layoutY": 234
        },
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log RPC from Device",
        "debugMode": false,
        "configuration": {
          "jsScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 273,
          "layoutY": 151
        },
        "type": "org.thingsboard.rule.engine.filter.TbMsgTypeSwitchNode",
        "name": "Message Type Switch",
        "debugMode": true,
        "configuration": {
          "version": 0
        }
      },
      {
        "additionalInfo": {
          "layoutX": 490,
          "layoutY": 35
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "Save Client Attributes",
        "debugMode": false,
        "configuration": {
          "scope": "CLIENT_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 963,
          "layoutY": 158
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "Save Timeseries",
        "debugMode": true,
        "configuration": {
          "defaultTTL": 0
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1076,
          "layoutY": 385
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsSwitchNode",
        "name": "al dispositivo",
        "debugMode": true,
        "configuration": {
          "jsScript": "return [metadata.deviceType];"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1080,
          "layoutY": 312
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "dispositivo permitido?",
        "debugMode": true,
        "configuration": {
          "jsScript": "return metadata.tiposDeDispositivos.split(\",\").indexOf(metadata.deviceType)>=0\n"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 1079,
          "layoutY": 240
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetCustomerAttributeNode",
        "name": "tiposDeDispositivos",
        "debugMode": true,
        "configuration": {
          "attrMapping": {
            "tiposDeDispositivos": "tiposDeDispositivos"
          },
          "telemetry": false
        }
      },
      {
        "additionalInfo": {
          "layoutX": 478,
          "layoutY": 545
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "alarma inactividad",
        "debugMode": true,
        "configuration": {
          "jsScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 16,
        "type": "Success"
      },
      {
        "fromIndex": 1,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 3,
        "toIndex": 5,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 4,
        "type": "Success"
      },
      {
        "fromIndex": 6,
        "toIndex": 3,
        "type": "editarPerfil"
      },
      {
        "fromIndex": 7,
        "toIndex": 1,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 13,
        "type": "Success"
      },
      {
        "fromIndex": 11,
        "toIndex": 0,
        "type": "Activity Event"
      },
      {
        "fromIndex": 11,
        "toIndex": 17,
        "type": "Inactivity Event"
      },
      {
        "fromIndex": 11,
        "toIndex": 7,
        "type": "Post telemetry"
      },
      {
        "fromIndex": 11,
        "toIndex": 9,
        "type": "Other"
      },
      {
        "fromIndex": 11,
        "toIndex": 12,
        "type": "Post attributes"
      },
      {
        "fromIndex": 11,
        "toIndex": 10,
        "type": "RPC Request from Device"
      },
      {
        "fromIndex": 11,
        "toIndex": 8,
        "type": "RPC Request to Device"
      },
      {
        "fromIndex": 13,
        "toIndex": 16,
        "type": "Success"
      },
      {
        "fromIndex": 13,
        "toIndex": 6,
        "type": "Success"
      },
      {
        "fromIndex": 15,
        "toIndex": 14,
        "type": "True"
      },
      {
        "fromIndex": 16,
        "toIndex": 15,
        "type": "Success"
      },
      {
        "fromIndex": 17,
        "toIndex": 16,
        "type": "Success"
      }
    ],
    "ruleChainConnections": [
      {
        "fromIndex": 6,
        "targetRuleChainId": {
          "entityType": "RULE_CHAIN",
          "id": "e9c2b450-701f-11ea-b4a5-4f0127e83283"
        },
        "additionalInfo": {
          "layoutX": 1436,
          "layoutY": 109,
          "ruleChainNodeId": "rule-chain-node-26"
        },
        "type": "borrarEntidad"
      },
      {
        "fromIndex": 6,
        "targetRuleChainId": {
          "entityType": "RULE_CHAIN",
          "id": "3e402ff0-68fd-11ea-a5d1-174bec7b16a7"
        },
        "additionalInfo": {
          "layoutX": 1438,
          "layoutY": 0,
          "ruleChainNodeId": "rule-chain-node-25"
        },
        "type": "editarEntidad"
      },
      {
        "fromIndex": 6,
        "targetRuleChainId": {
          "entityType": "RULE_CHAIN",
          "id": "7b293490-6dce-11ea-a995-07b73292ce47"
        },
        "additionalInfo": {
          "layoutX": 1437,
          "layoutY": 56,
          "ruleChainNodeId": "rule-chain-node-24"
        },
        "type": "crearEntidad"
      },
      {
        "fromIndex": 6,
        "targetRuleChainId": {
          "entityType": "RULE_CHAIN",
          "id": "cc9716b0-7587-11ea-b6f7-395813a5429b"
        },
        "additionalInfo": {
          "layoutX": 1438,
          "layoutY": 170,
          "ruleChainNodeId": "rule-chain-node-23"
        },
        "type": "configurarEntidad"
      },
      {
        "fromIndex": 14,
        "targetRuleChainId": {
          "entityType": "RULE_CHAIN",
          "id": "9aa12820-7367-11ea-b6f7-395813a5429b"
        },
        "additionalInfo": {
          "layoutX": 1349,
          "layoutY": 380,
          "ruleChainNodeId": "rule-chain-node-22"
        },
        "type": "V02_001"
      }
    ]
  }
}